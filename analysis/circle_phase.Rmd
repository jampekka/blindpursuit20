---
title: "Circle phases"
output: 
  html_notebook:
    code_folding: hide
---

```{r setup}
library(arrow)
library(ggpubr)
library(tidyverse)
```

# Read data
```{r}
df <- arrow::read_feather("C:/Users/tuisku.tammi/Documents/GitHub/tuisku/phd/1stexp_analysis/data/segments.feather")


df <- df %>%
  select(participant, ts, conf, gazeX:target_y, is_visible:trial_number, gazeX_s:end_seg_class) %>%
  mutate(is_cue = if_else(signtype == "cue", 1, 0),
         is_target = if_else(signtype == "target", 1, 0),
         is_success = if_else(signtype == "success", 1, 0)) %>%   
  mutate(is_trial = (is_cue == 1) | (is_target == 1)) # is_trial => trial without response, query, feedback

df <- df %>%
  group_by(participant) %>%
  mutate(is_gap = (ts - lag(ts)) > 2,
         is_gap = replace(is_gap, row_number() == 1, FALSE)) %>%
  group_by(participant, is_gap) %>%
  arrange(participant, ts) %>%
  mutate(seg_fill = lag(begin_seg_class)) %>%
  mutate(seg_fill = if_else(is.na(seg_fill), end_seg_class, seg_fill)) %>%
  fill(seg_fill) %>%
  mutate(seg_fill = if_else(is_gap, NA_real_, seg_fill)) %>%
  ungroup 

```



# Tidy main data


```{r}

df <- df %>% 
  mutate(across(c(begin_seg_class, end_seg_class, seg_fill, segment_class_2), 
                ~recode(., `1` = "pursuit", `2` = "saccade", 
                        `3` = "pursuit", `4` = "pursuit"))) %>%
    mutate(target_class = case_when(is_target == 1 ~ "target",
                           (is_visible == 1) & (is_cue == 1) ~ "visible",
                           (is_visible == 0) & (is_cue == 1) ~ "hidden",
                           TRUE  ~ NA_character_) %>% 
             factor(levels = c("visible", "hidden", "target"))) %>%
    mutate(target_phase_R = atan2(target_x, target_y),
           gaze_phase_R = atan2(gazeX_s, gazeY_s),
           target_radius = sqrt((target_x)^2 + (target_y)^2),
           gaze_radius = sqrt((gazeX_s)^2 + (gazeY_s)^2),
           phase_diff = gaze_phase_R - target_phase_R,
           radius_diff = gaze_radius - target_radius,
           x_rel = gazeX_s - target_x,
           y_rel = gazeY_s - target_y) %>%
  arrange(participant, ts) 

```


Create occluded_trial and success_trial variables, mark 1st occluded block as practice

```{r}

df <- df %>%
  mutate(trial_gap = is.na(trial_number)) %>%
  group_by(participant, trial_number) %>%
  mutate(trial_type = ifelse(mean(is_visible) == 1, 
                             "visible_trial", "occluded_trial"),
         success_trial = max(is_success)) %>%
  group_by(participant) %>%
  mutate(s1 = data.table::rleid(trial_gap) * !trial_gap, 
      s2 = (NA^!s1) * s1,
      block = match(s2, unique(na.omit(s2)))) %>%
  mutate(trial_type = if_else((trial_type == "occluded_trial") & (block == 2), "occluded_practice_trial", trial_type)) %>% 
  ungroup %>%
  mutate(participant = factor(participant))

# check number of trials per block
df %>%
  filter(is_trial) %>%
  group_by(participant, block, trial_type) %>%
  summarise(trials = n_distinct(trial_number, na.rm=T))

# check trial types per block (1 = visible, 2 = occluded practice, 3 & 4 = occluded)
df %>%
  filter(is_trial) %>%
  distinct(block, trial_type)


# there's one weird visible trial in block 2 for p8 (212)

```
#### Separate trial data  

**NOTE: trial_number now contains query, success, etc. The numbers are also different (used to start at 60 for circular trials). **

```{r}
df_trials1 <- df %>%
  filter(is_trial) %>%
  group_by(participant, trial_number) %>%
  mutate(trial_ts = ts - min(ts)) %>%
  group_by(participant, trial_number, is_visible) %>%
  mutate(occl_ts = if_else(!is_visible, ts - min(ts), NA_real_)) %>%
  ungroup %>%
  arrange(participant, trial_number, trial_ts)

```


Create "unwrapped phase variables" (per trial) to avoid jumps in phase values. These are used when phases are compared (phase difference, phase covered by saccades, etc.)

```{r fig.width=12}

# need to make 1st row of gaze phase to match the "units" of target phase; therefore the gathering/pivoting
# (e.g. participant 1 trial 315: target phase 3.13, gaze phase -3.10)
# but 1st row only, to avoid problems such as p10 trial 463

# df_trials <- df_trials1 %>%
#   group_by(participant, trial_number) %>% 
#   gather(var, orig, target_phase_R, gaze_phase_R) %>%
#   arrange(participant, trial_number, ts) %>%
#   mutate(unwrap = signal::unwrap(orig)) %>%
#   pivot_wider(names_from = var,
#               values_from = c(orig, unwrap)) %>%
#   ungroup %>%
#   mutate(phase_diff_unwrap = unwrap_gaze_phase_R - unwrap_target_phase_R) %>%
#   arrange(participant, trial_number, ts) 


# gaze_1stphase = gaze phase with first (temporary) row from target phase. This is to match the "cycles"
df_trials1 <- df_trials1 %>%
  group_by(participant, trial_number) %>% 
  arrange(participant, trial_number, ts) %>%
  mutate(phase_row = row_number()) %>%
  ungroup


df_trials <- df_trials1 %>%
   group_by(participant, trial_number) %>% 
  arrange(participant, trial_number, ts) %>%
   summarise(gaze_1stphase = first(target_phase_R)) %>%
   mutate(phase_row = 0) %>% 
   ungroup %>%
   bind_rows(df_trials1, .) %>% 
   arrange(participant, trial_number, phase_row) %>%
#  select(phase_row, target_phase_R, gaze_phase_R, gaze_1stphase) %>% 
   mutate(gaze_1stphase = if_else(!is.na(gaze_1stphase), gaze_1stphase, gaze_phase_R)) %>%
   group_by(participant, trial_number) %>% 
   mutate(unwrap_gaze_phase_R = signal::unwrap(gaze_1stphase)) %>% # unwrap gaze phase with 1st row
   filter(phase_row != 0) %>%
   mutate(unwrap_target_phase_R = signal::unwrap(target_phase_R),
          old_unwrap_gaze_phase_R = signal::unwrap(gaze_phase_R)) %>% # unwrap target + "old" gaze phase (without 1st row), for comparison
   ungroup %>%
   mutate(phase_diff_unwrap = unwrap_gaze_phase_R - unwrap_target_phase_R) %>%
   arrange(participant, trial_number, ts) 

  
```


#### Extract segment info

begin_segment_index: index of the segment that begins at this timestamp


```{r}
# get launch/landing from df 
segment_durations <- df_trials %>%
#  select(participant, block, ts, seg_fill) %>%
  group_by(participant) %>%
  arrange(participant, ts) %>%
  mutate(seg_index = data.table::rleid(seg_fill)) %>%
  group_by(participant, seg_index, seg_fill) %>%
  summarise(landing = max(ts), start_block = first(block), 
            end_block = last(block)) %>%
  group_by(participant) %>%
  mutate(launch = lag(landing)) %>% 
  ungroup %>% filter(!(start_block != end_block)) %>%
  rename(class = seg_fill) %>%
  select(-start_block, -end_block) %>%
  mutate(dur = landing - launch)

```


```{r}
segments <- segment_durations %>%
  select(-dur) %>%
  gather(timept, ts, launch, landing) %>%
  left_join(df_trials, by = c("participant", "ts"))

saccades <- segments %>%
  filter(class == "saccade", is_trial) %>%
  group_by(participant, trial_number, is_visible) %>%
  mutate(first_saccade = if_else((!is_visible) & (seg_index == min(seg_index)), T, F)) %>%
  arrange(participant, seg_index, desc(timept)) %>%
#  filter(!first_saccade) %>% # remove the first saccade of each occlusion: the one with the smallest index
  ungroup %>%
  arrange(participant, trial_number, trial_ts) %>%
  mutate(is_visible_cue = if_else(is_visible, "visible", "hidden"))

# pursuits <- segments %>%
#   filter(class == "pursuit", is_trial) %>%
#   group_by(participant, trial_number, is_visible) %>%
#   arrange(participant, seg_index, desc(timept)) %>%
#   ungroup %>%
#   arrange(participant, trial_number, trial_ts) %>%
#   mutate(is_visible_cue = if_else(is_visible, "visible", "hidden"))

```


Export saccade data to python for phase model

R:st√§ sakkaditiedosto pythoniin:
- hidden
- mukana phase (error) at disappearance
- mukana first_saccade: poista 1. sakkadi (pythonissa)
- long - timept

```{r}
trial_start_phases <- df_trials %>%
  filter(trial_type == "occluded_trial", target_class == "hidden") %>% 
  group_by(participant, trial_number) %>%
  filter(occl_ts == 0) %>% 
  mutate(first_saccade = F, timept = "trial_start") %>%
  select(participant, timept, ts, target_x,  target_y, trial_number:gazeY_s, trial_ts, occl_ts, 
         unwrap_gaze_phase_R, unwrap_target_phase_R, phase_diff_unwrap, first_saccade) %>%
  ungroup

exp_sacc <- saccades %>%
  filter(trial_type == "occluded_trial", target_class == "hidden") %>% 
  select(participant, timept, ts, target_x,  target_y, trial_number:gazeY_s, trial_ts, occl_ts, 
         unwrap_gaze_phase_R, unwrap_target_phase_R, phase_diff_unwrap, first_saccade) %>%
  rbind(trial_start_phases) %>%
  arrange(participant, trial_number, occl_ts)

#write_csv(exp_sacc, "saccades_hidden.csv")


```



# Circle task

## Success by phase

```{r}
df_trials %>% 
  filter(participant == 1, trial_number == 174) %>%
  ggplot(aes(target_x, target_y, color = orig_target_phase_R)) + geom_path(size=3, lineend = "round") + 
  scale_color_gradient2() +
  theme_bw() +
  coord_fixed() + labs(title = "Values of phase variable", color = "")

```

```{r}
target_phases <- df_trials %>%
  filter(is_target == 1) %>%
  group_by(participant, trial_number, success_trial) %>%
  summarise(target_phase = mean(orig_target_phase_R)) %>%
  ungroup %>%
  mutate(target_phase_bin = cut_interval(target_phase, 8)) %>% 
  group_by(target_phase_bin) %>%
  mutate(target_phase_bound = min(target_phase)) %>%
  group_by(participant, target_phase_bin, target_phase_bound) %>%
  summarise(success_rate = mean(success_trial),
            successes = sum(success_trial),
            trials = n()) %>%
  ungroup 

target_phases %>%
  ggplot(aes(target_phase_bound, success_rate)) + 
  geom_hline(aes(yintercept = .25), linetype = "dashed", alpha = .4) +  
  geom_col(alpha = .7) + 
  facet_wrap(~participant) +
  labs(x = "Phase (lower bound of bin)", y = "Success rate", title = "Participant-wise distributions of success rate by phase") +
  scale_y_continuous(labels = scales::percent) +
  scale_x_continuous(breaks = target_phases$target_phase_bound, 
                     labels = round(target_phases$target_phase_bound,1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


```

# Plot segmented data

**Segmentation is now done for full data.**

Visualising 1. raw time series and 2. gaze in xy coordinates as panel plots

```{r}
color_vals <- c( # actual colors used in the plot
                                "saccade" = "red", 
                                "pursuit" = "darkgreen", 
#                                "fixation" = "black",
                                "target" = "blue", 
                                "visible" = "deepskyblue",
                                "hidden" = "darksalmon",
                                # placeholder values for legend titles
                                " " = "white")

color_breaks <- c("saccade", "pursuit", " ", "target","visible","hidden")

```


## Time series

Random sampling of time segments

n samples for visible / occluded timepoints --> windows of width 20s around them


```{r}
set.seed(1)
times <- df %>%
  filter(trial_type == "occluded_trial", is_trial) %>%
  group_by(participant, is_visible) %>%
  slice_sample(n = 3) %>%
  ungroup %>%
  select(participant, ts) %>% arrange(participant, ts)

```

```{r }

plot_segm_times <- function(sbj, ts_center) {

  rects <- df %>%
    filter(participant == sbj, between(ts, ts_center - 10, ts_center + 10), 
           !is.na(trial_number)) %>%
    arrange(ts) %>%
    group_by(target_class_id = data.table::rleid(target_class), target_class) %>% 
    summarise(xmin = min(ts),
              xmax = max(ts)) %>%
    ungroup %>%
    mutate(ymin = -20, ymax = 20)

    title <- paste("Participant", sbj)

  df %>%
    filter(participant == sbj, between(ts, ts_center - 10, ts_center + 10), 
           !is.na(trial_number)) %>%
    select(ts, gazeX, gazeY, gazeX_s, gazeY_s, seg_fill, target_class) %>%
    rename(segm_X = gazeX_s,
           segm_Y = gazeY_s,
           gaze_X = gazeX,
           gaze_Y = gazeY) %>%
    gather(var, value, gaze_X:segm_Y) %>%
    separate(var, into = c("var", "coord")) %>%
    spread(var, value) %>%
    ggplot() +
    geom_rect(data=rects, aes(xmin=xmin, ymin=ymin, xmax=xmax, ymax=ymax,
        fill=target_class), alpha = .4) +
    geom_path(aes(ts, gaze, color = "original gaze"), alpha = .8) +
    geom_path(aes(ts, segm, color = seg_fill, group=1), alpha = .8) +
    facet_grid(coord~., switch = "y") +
    labs(x = "time", title = title, colour = "") +
    scale_y_continuous(limits = c(-20, 20)) +
    theme_bw() +
    scale_color_manual(breaks=c(color_breaks, "original gaze"),
                       values = c(color_vals, "original gaze" = "darkgrey"),
                     drop = F)   + 
    scale_fill_manual(breaks=color_breaks,
                       values = color_vals,
                     drop = F)  +
    theme(strip.placement = "outside", 
          strip.background = element_blank())

}


```

```{r fig.width=14, fig.height=7, message=F}
segment_plots_times <- mapply(plot_segm_times, times$participant, times$ts, SIMPLIFY = F)
 
 
pdf("time_series_segments.pdf", width = 12, height = 7)
 invisible(lapply(segment_plots_times, print))
 dev.off()
```




Random sampling of trials

Sample visible and hidden trials


```{r}
set.seed(1)
trials <- df_trials %>% 
  filter((participant != 8) | (ts < 99000), is_trial, trial_type != "occluded_practice_trial") %>%
  group_by(participant, trial_number, trial_type) %>%
  summarise(trial_duration = max(ts) - min(ts)) %>% 
  group_by(participant, trial_type) %>%
  slice_sample(n = 3) %>% # n visible, n hidden trials per participant
  ungroup %>%
  arrange(participant, desc(trial_type))

```
## Trial plots

### Time series plot of trial

```{r }

plot_segm <- function(sbj, trialn) {
  

  rects <- df_trials %>%
    filter(participant == sbj, trial_number == trialn) %>%
    arrange(trial_ts) %>%
    group_by(trial_number, target_class) %>%
    summarise(xmin = min(trial_ts),
              xmax = max(trial_ts)) %>%
    ungroup %>%
    mutate(ymin = -20, ymax = 20)
  
    title <- paste0("Participant ", sbj, ", trial ", trialn)
  
    trialdur <- df_trials %>%
    filter(participant == sbj, trial_number == trialn) %>%
      summarise(trial_duration = max(trial_ts)) %>%
      pull(trial_duration)
  
  df_trials %>%
    filter(participant == sbj, trial_number == trialn) %>%
    select(trial_ts, gazeX, gazeY, gazeX_s, gazeY_s, seg_fill, target_class) %>%
    rename(segm_X = gazeX_s,
           segm_Y = gazeY_s,
           gaze_X = gazeX,
           gaze_Y = gazeY) %>%
    gather(var, value, gaze_X:segm_Y) %>%
    separate(var, into = c("var", "coord")) %>%
    spread(var, value) %>%
    ggplot() + 
    geom_rect(data=rects, aes(xmin=xmin, ymin=ymin, xmax=xmax, ymax=ymax, 
        fill=target_class, group=1), alpha = .4) +  
    geom_path(aes(trial_ts, segm, color = seg_fill, group=1), alpha = .8) +
    facet_grid(coord~., switch = "y") +
    labs(title = title, colour = "",  y = "", x = "Time from trial start (s)") +
    scale_y_continuous(limits = c(-20, 20)) +
    theme_bw() +
    scale_color_manual(breaks=c(color_breaks, "isochronic lines"),
                       values = c(color_vals, "isochronic lines" = "orange"),
                     drop = F)  + 
    scale_fill_manual(color_breaks,
                       values = color_vals,
                     drop = F) +
    coord_fixed(ratio = .05)  + 
#    guides(col = guide_legend(override.aes = list(shape = 15, size = 8))) +
    theme(strip.placement = "outside", 
          strip.background = element_blank())
    
}


```

```{r fig.width=14, fig.height=7, message=F}
segment_plots <- mapply(plot_segm, trials$participant, trials$trial_number, SIMPLIFY = F)

```

### Circular plot of trial

```{r}

plot_trial <- function(sbj, trialn) {

  isochronic_lines <- df_trials %>%
    filter(participant == sbj, trial_number == trialn) %>%
    mutate(across(c(target_x, target_y, gazeX_s, gazeY_s), .names = "{col}_segm")) %>%
    slice(seq(1, n(), 100)) %>%
    select(ends_with("segm")) %>%
    rename(gaze_x_segm = gazeX_s_segm, gaze_y_segm = gazeY_s_segm) %>%
    rownames_to_column() %>%
    gather(var, value, -rowname) %>%
    separate(var, into = c("var", "coord"), extra = "drop") %>%
    spread(coord, value) %>%
    arrange(rowname, desc(var)) 
  
    title <- paste0("Participant ", sbj, ", trial ", trialn)
  
  p <- df_trials %>%
    filter(participant == sbj, trial_number == trialn) %>%
    ggplot() + 
    geom_path(aes(target_x, target_y, color = target_class, group=1), 
              alpha = .8, show.legend = F) +
    geom_line(data = isochronic_lines, aes(x, y, group = rowname, color = "isochronic lines"), 
              linetype = "dashed", inherit.aes = F) +
    geom_path(aes(gazeX_s, gazeY_s, color = seg_fill, group=1), 
              alpha = 1, inherit.aes = F) +
    geom_point(aes(0, 0, color = " "), alpha = 0) +
    labs(colour = "", title = title) +
    coord_fixed() +
    theme_bw()  +
    scale_y_continuous(limits = c(-16, 16)) +
    scale_x_continuous(limits = c(-16, 16)) +
    scale_color_manual(breaks=c(color_breaks, "isochronic lines"),
                       values = c(color_vals, "isochronic lines" = "orange"),
                     drop = F) # + 
  #   scale_fill_manual(breaks=color_breaks[4:7],
  #                      values = color_vals[4:7],
  #                    drop = F)  + 
  # guides(fill = guide_legend(override.aes = list(shape = 15, size = 8)))
  
  p
  
}


```



```{r fig.width=12}

trialplots <- mapply(plot_trial, trials$participant, trials$trial_number, SIMPLIFY = F)


```

Plot time series and circles in grid


```{r fig.height=7, fig.width=12}

panel_plots <- lapply(1:60, function(i) {
  ggarrange(trialplots[[i]], segment_plots[[i]] + labs(title = ""), common.legend = T, legend = "right")
})


pdf("circle_ts_panelplots.pdf", width = 12, height = 7)
invisible(lapply(panel_plots, print))
dev.off()

```

# Gaze distribution relative to target


For segmented data; saccade launch & landing points

1st saccades after occlusion removed


### Participant-wise

Make axis limits identical

```{r }

saccades %>%
  filter(!first_saccade) %>% 
#  filter(abs(x_rel) < 20, abs(y_rel) < 20) %>% # TODO: remove this filter after fixing conf
  filter(is_cue == 1, trial_type == "occluded_trial") %>%
  ggplot(aes(x_rel, y_rel, colour = timept)) + geom_point(alpha = .1) +
  facet_wrap(participant~is_visible_cue, ncol = 6) +
  geom_vline(aes(xintercept = 0), alpha = .5) +
  geom_hline(aes(yintercept = 0), alpha = .5) +
  scale_x_continuous(limits = c(-25, 25)) +
  scale_y_continuous(limits = c(-25, 25)) +
  labs(title = "Saccade launch/landing points relative to hidden/visible target (cue)", 
       subtitle = "Participant-wise distributions, occluded trials",
       colour = "", x = "x", y = "y") +
  theme_bw() +
  coord_fixed() + 
  guides(colour = guide_legend(override.aes = list(alpha = 1)))


```



```{r fig.width=10, fig.height=7}

saccades %>% 
  filter(!first_saccade) %>% 
  filter(is_cue == 1, !is.na(timept), trial_type == "occluded_trial") %>%
  ggplot(aes(phase_diff_unwrap, fill = timept)) + 
  geom_histogram(binwidth=.2, position = "identity", alpha = .4) +
  scale_x_continuous(limits = c(-2,2)) +
  geom_vline(aes(xintercept = 0), alpha = .5) +
  facet_wrap(participant~is_visible_cue, scales = "free_y", ncol=6)  +
  labs(title = "Phase difference between saccades and hidden/visible object",
       subtitle = "Participant-wise distributions, occluded trials", fill = "") +
  theme_bw() 

```

```{r fig.width=10}
saccades %>% 
  filter(!first_saccade) %>% 
  filter(is_cue == 1, !is.na(timept), trial_type == "occluded_trial") %>%
  ggplot(aes(radius_diff, fill = timept)) + 
  geom_histogram(binwidth=1, position = "identity", alpha = .4) +
  scale_x_continuous(limits = c(-13.5,13.5)) +
  geom_vline(aes(xintercept = 0), alpha = .5) +
  facet_wrap(participant~is_visible_cue, scales = "free_y", ncol=6)   +
  labs(title = "Radius difference between saccades and hidden/visible object",
       subtitle = "Participant-wise distributions, occluded trials", fill = "") +
  theme_bw() 

```

### Average

```{r}

saccades %>% 
  filter(!first_saccade) %>% 
  filter(is_cue == 1, !is.na(timept), trial_type == "occluded_trial") %>%
  ggplot(aes(phase_diff_unwrap, fill = timept)) + 
  geom_histogram(binwidth=.08, position = "identity", alpha = .4) +
  scale_x_continuous(limits = c(-2,2)) +
  geom_vline(aes(xintercept = 0), alpha = .5) +
  facet_wrap(~is_visible_cue, scales = "free_y", ncol=2)  +
  labs(title = "Phase difference between saccades and hidden/visible object",
       subtitle = "All participants, occluded trials") +
  theme_bw() 
```


```{r message=F}
saccades %>% 
filter(!first_saccade) %>% 
  filter(is_cue == 1, !is.na(timept), trial_type == "occluded_trial") %>%
  ggplot(aes(radius_diff, fill = timept)) + 
  geom_histogram(binwidth=1, position = "identity", alpha = .4) +
  scale_x_continuous(limits = c(-13.5,13.5)) +
  geom_vline(aes(xintercept = 0), alpha = .5) +
  facet_wrap(~is_visible, scales = "free_y", ncol=2)   +
  labs(title = "Radius difference between saccades and hidden/visible target (cue)",
       subtitle = "All participants, occluded trials") +
  theme_bw() 
```


# Gaze distribution relative to target (at target reappearance)

### Participant-wise

```{r fig.width = 10, fig.height=15}
df_trials %>%
  filter(is_target == 1, trial_type == "occluded_trial") %>% 
  group_by(participant, trial_number, success_trial) %>%
  slice(1) %>%
  ungroup %>%
  mutate(success_trial = ifelse(success_trial == 1, "correct", "false")) %>%
  ggplot(aes(x_rel, y_rel)) + geom_point(alpha = .2) +
  facet_wrap(participant~success_trial, ncol = 4) +
  geom_vline(aes(xintercept = 0), alpha = .5) +
  geom_hline(aes(yintercept = 0), alpha = .5) +
  scale_x_continuous(limits = c(-20, 20)) +
  scale_y_continuous(limits = c(-20, 20)) +
  labs(title = "Gaze position relative to object (at target appearance)", 
       subtitle = "Participant-wise distributions, occluded trials",
       colour = "", x = "x", y = "y") +
  theme_bw() +
  coord_fixed()

```

```{r fig.width = 10}

df_trials %>%
  filter(is_target == 1, trial_type == "occluded_trial") %>%
  group_by(participant, trial_number, success_trial) %>%
  slice(1) %>%
  ungroup %>%
  mutate(success_trial = ifelse(success_trial == 1, "correct", "false")) %>%
  ggplot(aes(phase_diff_unwrap)) + 
  geom_histogram(binwidth=.15, alpha = .6) +
  scale_x_continuous(limits = c(-2,2)) +
  geom_vline(aes(xintercept = 0), alpha = .5) +
  facet_wrap(~participant, ncol = 5, scales = "free_y") +
  labs(title = "Phase difference between gaze and object (at target appearance)",
       subtitle = "Participant-wise distributions, occluded trials") +
  theme_bw() 


```

```{r }
df_trials %>%
  filter(is_target == 1) %>%
  group_by(participant, trial_number, success_trial) %>%
  slice(1) %>%
  ungroup %>%
  mutate(success_trial = ifelse(success_trial == 1, "correct", "false")) %>%
  ggplot(aes(radius_diff, fill = trial_type)) + 
  geom_histogram(binwidth=1, position = "identity", alpha = .6) +
  scale_x_continuous(limits = c(-20,20)) +
  geom_vline(aes(xintercept = 0), alpha = .5) +
  facet_wrap(participant~success_trial, ncol = 6, scales = "free_y") +
  labs(title = "Radius difference between gaze and target (at target reappearance)",
       subtitle = "Participant-wise distributions, occluded trials") +
  theme_bw() 

```

#### Success rate by distance

```{r message=F, fig.width=9, fig.height=7}
abs_dist <- df_trials %>%
  filter(is_target == 1) %>%
  group_by(participant, trial_number, success_trial, trial_type) %>%
  slice(1) %>%
  ungroup %>%
  mutate(abs_dist = abs(sqrt((gazeX_s - target_x)^2 + (gazeY_s -target_y)^2))) %>%
  mutate(abs_dist_bin = cut_number(abs_dist, 4)) %>%
  group_by(abs_dist_bin) %>%
  mutate(abs_dist_bound = min(abs_dist)) %>%
  group_by(participant, trial_type, abs_dist_bin, abs_dist_bound) %>%
  summarise(success_rate = mean(success_trial),
            successes = sum(success_trial),
            trials = n()) %>%
  ungroup 

abs_dist %>%
  mutate(correct_trials = paste0(successes, '/', trials)) %>%
  ggplot(aes(abs_dist_bound, success_rate)) + 
  geom_hline(aes(yintercept = .25), linetype = "dashed", alpha = .4) +  
  geom_col(alpha = .7) + 
  facet_wrap(trial_type~participant) +
  labs(title = "Participant-wise success rates by distance of gaze from target (at target reappearance)", 
       x = "Absolute distance (lower bound of bin)", y = "Success rate") +
  scale_y_continuous(labels = scales::percent, limits = c(0,1.05)) +
  scale_x_continuous(breaks = abs_dist$abs_dist_bound, labels = round(abs_dist$abs_dist_bound,2)) +
  geom_text(aes(label = correct_trials), vjust = -.2) +
  theme_bw()
```

```{r fig.width=10}
# df %>%
#   filter(is_target == 1) %>%
#   group_by(participant, trial_number, success_trial) %>%
#   slice(1) %>%
#   ungroup %>%
#   mutate(abs_dist = abs(sqrt((gazeX_s - target_x)^2 + (gazeY_s -target_y)^2))) %>%
#   arrange(participant, abs_dist) %>% 
#   group_by(participant) %>%
#   mutate(cum_successes = cumsum(success_trial),
#          cum_trials = row_number(),
#         cum_successrate = cum_successes/cum_trials) %>%
#   mutate(correct_trials = paste0(cum_successes, '/', cum_trials)) %>%
#   ggplot(aes(abs_dist, cum_successrate)) + geom_point() +
#   geom_hline(aes(yintercept = .25), linetype = "dashed", alpha = .4) +    
#   facet_wrap(~participant) +
#   labs(x = "Absolute distance", y = "Cumulative success rate", 
#        title = "Cumulative success rates by distance of gaze from target (at target reappearance)") + 
#   scale_y_continuous(labels = scales::percent, limits = c(0,1.05)) +
#   theme_bw()
# 
# df %>%
#   filter(is_target == 1) %>%
#   group_by(participant, trial_number, success_trial) %>%
#   slice(1) %>%
#   ungroup %>%
#   mutate(abs_dist = abs(sqrt((gazeX_s - target_x)^2 + (gazeY_s -target_y)^2))) %>%
#   arrange(participant, abs_dist) %>% 
#   group_by(participant) %>%
#   mutate(abs_dist_bin = cut_number(abs_dist, 6)) %>%
#   group_by(abs_dist_bin) %>%
#   mutate(abs_dist_bound = min(abs_dist)) %>%
#   group_by(participant, abs_dist_bin, abs_dist_bound) %>%
#   summarise(success_rate = mean(success_trial),
#             successes = sum(success_trial),
#             trials = n()) %>%
#   arrange(participant, abs_dist_bound) %>%
#   group_by(participant) %>%
#   mutate(cum_successes = cumsum(successes),
#          cum_trials = cumsum(trials),
#         cum_successrate = cum_successes/cum_trials) %>%
#   mutate(correct_trials = paste0(cum_successes, '/', cum_trials)) %>% 
#   ggplot(aes(abs_dist_bound, cum_successrate)) + geom_point() +
#   geom_hline(aes(yintercept = .25), linetype = "dashed", alpha = .4) +    
#   facet_wrap(~participant) +
#   labs(x = "Absolute distance (lower bound of bin)", y = "Cumulative success rate", 
#        title = "Success rate", subtitle = "Participants have different bin widths") +
#   scale_y_continuous(labels = scales::percent, limits = c(0,1.05)) +
#   geom_text(aes(label = trials), vjust = -.2) +
#   theme_bw() 

```

# Tracking behaviour (pursuits/fixations)

pursuit parameters and velocity-matching during occluded tracking

### Duration of pursuits

Note that segments overlapping target classes (visible/hidden/NA) have been removed.

```{r fig.width=11}

segment_durations_df <- segments %>%
  filter(target_class %in% c('visible', 'hidden'), class == "pursuit", 
         trial_type == "occluded_trial") %>%
  select(participant:ts, target_class) %>% 
  spread(timept, ts) %>% # segments with landing/launch at different target classes not included
  mutate(dur = landing - launch) %>% # 2,048 rows with NA (1/3)
  filter(!is.na(dur)) 

segment_durations_df %>%
  ggplot(aes(dur, fill=target_class)) + 
  geom_density(alpha=.4) +
#    geom_histogram(alpha=.4, binwidth = .02) + 
  facet_wrap(~participant, scales = "free_y") +
  labs(title = "Pursuit durations", 
       subtitle = "Participant-wise distributions, occluded trials",
       x = "Duration (s)") +
  theme_bw()
  
```

# Headtracking


```{r}
# headtracking coords to degrees to match gaze
degs_per_pix = 80/1920

df <- df %>%
  mutate(head_deg_x = (head_screen_x - 1920/2) * degs_per_pix,
         head_deg_y = (head_screen_y - 1080/2) * degs_per_pix) 


```


```{r}

plot_head <- function(sbj, ts_center) {

    rects <- df %>%
    filter(participant == sbj, between(ts, ts_center - 20, ts_center + 20), 
           !is.na(trial_number), !is.na(target_class)) %>%
    arrange(ts) %>%
    group_by(target_class_id = data.table::rleid(target_class), target_class) %>% 
    summarise(xmin = min(ts),
              xmax = max(ts)) %>%
    ungroup %>%
    mutate(ymin = -20, ymax = 20)

    title <- paste("Participant", sbj)

  xplot <- df %>%
    filter(participant == sbj, between(ts, ts_center - 20, ts_center + 20), 
           !is.na(trial_number)) %>%
    gather(var, value, head_deg_x, gazeX_s) %>%
    mutate(var = recode(var, gazeX_s = "gaze", head_deg_x = "head"))  %>%
#    mutate(var = str_remove(var, "head_deg_")) %>%
    ggplot() +
   geom_rect(data=rects, aes(xmin=xmin, ymin=ymin, xmax=xmax, ymax=ymax,
        fill=target_class), alpha = .15) +
    geom_path(aes(ts, value, color = var), alpha = .8) +
#    facet_grid(var~., switch = "y", scales = "free_y") +
    labs(x = "time (s)", title = title, y = "", color = "", fill = "") +
    scale_x_continuous(limits = c(min(rects$xmin), max(rects$xmax))) +
  scale_y_continuous(limits = c(-20, 20), name = "X (degrees)",
    sec.axis = sec_axis( trans=~./degs_per_pix + 1920/2, name="screen coordinates")) +
    theme_bw()  +
    theme(axis.text.x = element_blank(),
                                        axis.ticks.x = element_blank(),
                                        axis.title.x = element_blank(),
                                        axis.text.y.right = element_text(color = "grey"),
                                        axis.title.y.right = element_text(color = "grey"),
                                        axis.ticks.y.right = element_line(color = "grey")) +
          scale_fill_manual(breaks=c("visible", "hidden", "target", " "),
                       values = color_vals[3:6],
                     drop = F)  
  
    yplot <- df %>%
    filter(participant == sbj, between(ts, ts_center - 20, ts_center + 20), 
           !is.na(trial_number)) %>%
    gather(var, value, head_deg_y, gazeY_s) %>%
    mutate(var = recode(var, gazeY_s = "gaze", head_deg_y = "head"))  %>%
#    mutate(var = str_remove(var, "head_deg_")) %>%
    ggplot() +
   geom_rect(data=rects, aes(xmin=xmin, ymin=ymin, xmax=xmax, ymax=ymax,
        fill=target_class), alpha = .15) +
    geom_path(aes(ts, value, color = var), alpha = .8) +
 #   facet_grid(var~., switch = "y", scales = "free_y") +
    labs(x = "time (s)", y = "", color = "", fill = "") +
      scale_x_continuous(limits = c(min(rects$xmin), max(rects$xmax))) +
  scale_y_continuous(limits = c(-20, 20), name = "Y (degrees)",
    sec.axis = sec_axis( trans=~./degs_per_pix + 1080/2, name="screen coordinates")) +
    theme_bw()   +
    theme(axis.text.y.right = element_text(color = "grey"),
                                        axis.title.y.right = element_text(color = "grey"),
                                        axis.ticks.y.right = element_line(color = "grey")) +
          scale_fill_manual(breaks=c("visible", "hidden", "target", " "),
                       values = color_vals[3:6],
                     drop = F)  

    p <- ggarrange(xplot, yplot, ncol = 1, common.legend = T)
    
    p
    
}

```

```{r message=F}
headtr_plots_times <- mapply(plot_head, times$participant, times$ts, SIMPLIFY = F)
 
```

```{r}

pdf("headtracking_new.pdf", width = 12, height = 7)
invisible(lapply(headtr_plots_times, print))
dev.off()

```

```{r}
# saveRDS(df_trials, 'df_trials.RDS')
# saveRDS(saccades, 'saccades.RDS')

```


# Results

## only with trial_type == "occluded_trial"

## 1. Saccade frequency in hidden vs. visible
(saccades / second)

```{r}
  
# trial-level numbers
df_dur <- df_trials %>%
  filter(signtype == "cue", trial_type == "occluded_trial", 
         target_class %in% c("visible", "hidden")) %>%
  spread(target_class, ts) %>%
  group_by(participant, trial_number) %>%
  summarise(visible = max(visible, na.rm=T) - min(visible, na.rm=T),
            hidden = max(hidden, na.rm=T) - min(hidden, na.rm=T)) %>%
  ungroup %>%
  pivot_longer(cols = c("visible", "hidden"),
               names_to = "target_class",
               values_to = "duration") %>%
  filter(!is.infinite(duration))

trial_saccades <- saccades %>%
  filter(signtype == "cue", trial_type == "occluded_trial") %>%
  group_by(participant, seg_index, target_class) %>%
  filter(n_distinct(timept) == 2) %>% # pick saccades with both ends inside hidden/visible cue
  group_by(participant, trial_number, target_class) %>%
  summarise(saccades = n_distinct(seg_index)) %>%
  ungroup %>%
  left_join(df_dur, by = c("participant", "trial_number", "target_class")) %>%
  mutate(freq = saccades/duration)

# calculate frequency from pooled trials; very close
trial_saccades %>%
  group_by(participant, target_class) %>%
  summarise(saccades = sum(saccades),
            duration = sum(duration)) %>%
  mutate(freq_pooled = saccades/duration)

trial_saccades %>%
  group_by(participant, target_class) %>%
  summarise(mean_freq = mean(freq),
            sd_freq = sd(freq))

```
##### (Multilevel) regression model  
*Visible object* as reference category: coefficients 2.01 (intercept) for visible and +0.79 (slope) for hidden.  

Variance across participants is .49 for intercept and .42 for slope.  

```{r}

trial_saccades <- trial_saccades %>%
  mutate(target_class = factor(target_class, levels = c("visible", "hidden")))

# LMM, random slope + intercept for participant
fit <- lmer(freq ~ target_class + (target_class|participant), data = trial_saccades)

summary(fit)


```
<br>
<br>

Plot random effects

```{r}
rr <- ranef(fit,condVar=TRUE)
aa <- broom.mixed::augment(rr)


aa %>% 
  mutate(variable = recode(variable, `(Intercept)` = "Intercept (visible)", target_classhidden = "Slope (hidden vs. visible)"))  %>%
  ggplot(aes(estimate, level, xmin=lb, xmax=ub)) +
  geom_errorbarh(height = 0)+
  geom_vline(xintercept = 0, lty = 2)+
  geom_point() + facet_wrap(~variable, scales = "free_x") +
  labs(y = "participant") +
  theme_bw()

```
<br>
<br>



```{r fig.width=10}

trial_saccades %>%
  gather(var, value, saccades:freq) %>%
  ggplot(aes(factor(participant), value, fill = target_class)) + geom_boxplot(alpha = .5) +
  facet_wrap(~var, scales = "free", ncol = 1) +
  theme_bw()

trial_saccades %>%
  ggplot(aes(factor(participant), freq, fill = target_class, color = target_class)) + 
  geom_violin(alpha = .4) +
  geom_dotplot(binaxis = "y", binwidth = .1, stackdir = "center", 
               position = "dodge", alpha = .4) +
  theme_bw()

```

Trial level plot: occlusion duration vs. saccade frequency

```{r}
trial_saccades %>%
  filter(target_class == "hidden") %>%
  ggplot(aes(duration, freq)) +
  geom_point(alpha = .4) +
  scale_y_continuous(limits = c(0,6)) +
  facet_wrap(~participant) #+ 
  #geom_smooth()

```


##### Participant 7 trials with high saccade frequency

```{r fig.width=10, fig.height=7, message=F}

rects <- df_trials %>% 
  filter(participant == "7", between(trial_number, 369, 373), 
         target_class %in% c("visible", "hidden")) %>%
  group_by(trial_number, target_class) %>%
  summarise(xmin = min(ts), xmax = max(ts)) %>%
  left_join(trial_saccades %>% filter(participant == "7"))

p7_launch <- saccades %>% 
  filter(participant == "7", between(trial_number, 369, 373), timept == "launch") %>%
  gather(var, svalue, gazeX_s, gazeY_s)  %>%
  mutate(var = recode(var, gazeX_s = "X", gazeY_s = "Y")) %>%
  rename(slaunch = ts)

p7 <- df_trials %>% 
  filter(participant == "7", between(trial_number, 369, 373)) %>% 
  gather(var, value, gazeX_s, gazeY_s) %>%
  mutate(var = recode(var, gazeX_s = "X", gazeY_s = "Y")) %>%
  ggplot(aes(ts, value, group = trial_number)) + 
  geom_path(alpha = .6) +
  geom_rect(data=rects, aes(xmin=xmin, ymin=-20, xmax=xmax, ymax=20,
        fill=target_class), alpha = .2, inherit.aes = F) +
  geom_point(data = p7_launch, aes(slaunch, svalue), color = "red", size = 1) +
  geom_text(data = rects  %>% mutate(var = "X"), 
            aes(xmin + .5, 17, label = round(freq,1)), inherit.aes = F, color = "blue") +
  facet_wrap(~var, ncol = 1, strip.position = "left") +
  scale_y_continuous(limits = c(-20, 20)) +
  scale_x_continuous(limits = c(min(rects$xmin), max(rects$xmax))) +
  theme_bw() +   
  scale_color_manual(breaks=color_breaks,
                       values = color_vals,
                     drop = F) +
  labs(y = "", x = "time (s)") +
  theme(legend.position = "none", 
        strip.placement = "outside", 
          strip.background = element_blank())


pp7 <- plotly::ggplotly(p7, tooltip = "slaunch", layerData = 1)

pp7

htmlwidgets::saveWidget(pp7, "participant7_saccadeFreq_new.html")
```

### Saccade frequency over time in occluded trials

Times of saccades during occlusion (by launch)

Nice to have:
My√∂s frekvenssin muutos ajan yli okkluusiossa
Ikkuna tai kumulatiivinen (skaalattuna trialien m√§√§r√§ll√§)
Sakkadien amplitudit ajan funktiona

```{r}

saccadetimes <- saccades %>%
  filter(signtype == "cue", trial_type == "occluded_trial", target_class == "hidden") %>%
  arrange(participant, seg_index, desc(timept)) %>%
  group_by(participant, seg_index) %>%
  mutate(dist = sqrt((gazeX_s - lag(gazeX_s))^2 + (gazeY_s - lag(gazeY_s))^2) %>% lead) %>%
  filter(timept == "launch")  %>%
  select(participant, seg_index, occl_ts, dist, trial_number) %>%
  left_join(trial_saccades %>% filter(target_class == "hidden"), by = c("participant", "trial_number")) %>%
  group_by(participant, trial_number) %>%
  filter(saccades == n_distinct(seg_index)) %>% # remove saccades that are not fully in hidden
  ungroup %>%
  select(participant, seg_index, occl_ts, dist, trial_number) 
  
occl_ts_saccades <- df_trials %>%
  filter(signtype == "cue", trial_type == "occluded_trial", target_class == "hidden") %>%
  select(participant, trial_number, occl_ts) %>%
  full_join(saccadetimes, by = c("participant", "trial_number", "occl_ts"))

```



Occlusion ts vs. cumulative saccades; if constant over time, should be linear
```{r}
saccadetimes %>% 
  arrange(participant, trial_number, occl_ts) %>%
  group_by(participant, trial_number) %>%
  mutate(cumulative_saccades = cumsum(!is.na(seg_index))) %>%
  group_by(participant) %>%
  mutate(slope = round(lm(cumulative_saccades ~ occl_ts)$coefficients[2], 2)) %>%
  ungroup %>%
  mutate(participant2 = paste0(participant, " (slope ", slope, ")") %>% factor) %>%
  mutate(participant2 = fct_reorder(participant2, as.numeric(participant))) %>%
  ggplot(aes(occl_ts, cumulative_saccades, 
             group = interaction(participant, trial_number), color = participant)) + 
  geom_line(alpha = .25) +
  facet_wrap(~participant2) +
  geom_smooth(aes(occl_ts, cumulative_saccades, color = participant), inherit.aes = F,  
              method = "lm", se = F, linetype = "dashed") +
  theme_bw() +
  theme(legend.position = "none")

# with free scales
saccadetimes %>%
  arrange(participant, trial_number, occl_ts) %>%
  group_by(participant, trial_number) %>%
  mutate(cumulative_saccades = cumsum(!is.na(seg_index))) %>%
  ggplot(aes(occl_ts, cumulative_saccades, 
             group = interaction(participant, trial_number), color = participant)) + 
  geom_line(alpha = .3) +
  facet_wrap(~participant) +
  geom_smooth(aes(occl_ts, cumulative_saccades, color = participant), inherit.aes = F,  
              method = "lm", se = F, linetype = "dashed") +
  theme_bw()

# with all timestamps from occlusion
# occl_ts_saccades %>%
#   arrange(participant, trial_number, occl_ts) %>%
#   group_by(participant, trial_number) %>%
#   mutate(cumulative_saccades = cumsum(!is.na(seg_index))) %>%
#   ggplot(aes(occl_ts, cumulative_saccades, 
#              group = interaction(participant, trial_number), color = participant)) + 
#   geom_line(alpha = .6) +
#   facet_wrap(~participant) +
#   geom_smooth(aes(occl_ts, cumulative_saccades), inherit.aes = F,  method = "lm", se = F) +
#   theme_bw()

```

Model: cumulative saccades ~ occl_ts
```{r}
# should account for count data? poisson?

saccadetimes2 <- saccadetimes %>%
  arrange(participant, trial_number, occl_ts) %>%
  group_by(participant, trial_number) %>%
  mutate(cumulative_saccades = cumsum(!is.na(seg_index))) %>% ungroup

fit_ts <- lmer(cumulative_saccades ~ occl_ts + (occl_ts|participant), data = saccadetimes2)

summary(fit_ts)

broom.mixed::augment(fit_ts) %>% 
  ggplot(aes(occl_ts, cumulative_saccades, color = participant)) + 
  geom_point(alpha = .25) +
  geom_line(aes(occl_ts, .fitted), size = 2) +
  facet_wrap(~participant) +
  theme_bw() +
  theme(legend.position = "none")

fit_ts2 <- lmer(cumulative_saccades ~ occl_ts + (occl_ts|participant/trial_number), data = saccadetimes2)

summary(fit_ts2)

broom.mixed::augment(fit_ts2) %>% 
  ggplot(aes(occl_ts, cumulative_saccades, color = participant)) + 
  geom_point(alpha = .25) +
  geom_line(aes(occl_ts, .fitted, group = trial_number), alpha = .5) +
  facet_wrap(~participant) +
  theme_bw() +
  theme(legend.position = "none")


```


Sum count per bin -> cumulative sum / n of trials

```{r}
occl_ts_saccades %>%
  mutate(occl_bin = cut_width(occl_ts, 1/50), boundary = 0) %>%
  group_by(participant, occl_bin) %>%
  summarise(saccades = sum(!is.na(seg_index)),
            trials = n_distinct(trial_number),
            occl_ts_bound = max(occl_ts)) %>%
  arrange(participant, occl_ts_bound) %>%
  mutate(saccades_per_trial = saccades / trials, # scale count by n of trials
         cumulative_saccades = cumsum(saccades_per_trial),
         cs_freq = cumulative_saccades / occl_ts_bound) %>% 
  ggplot(aes(occl_ts_bound, cs_freq)) + geom_path() +
  facet_wrap(~participant) +
  labs(title = "Saccade frequency over time (cumulative saccades per trial / time)",
       y = "Cumulative frequency (saccades / s)") +
  theme_bw()


```


```{r}
# # saccades in trials
# occl_ts_saccades %>%
#   arrange(participant, trial_number, occl_ts) %>%
#   group_by(participant) %>%
#   mutate(trialn = data.table::rleid(trial_number) %>% factor) %>%
#   group_by(participant, trialn) %>%
#   mutate(saccade = !is.na(seg_index),
#          cumulative_saccades = cumsum(!is.na(seg_index)),
#          saccade_freq = cumulative_saccades/occl_ts,
#          min_ts = min(occl_ts),
#          max_ts = max(occl_ts)) %>%
#   ungroup %>%
#   mutate(occl_ts2 = ifelse(saccade, occl_ts, NA_real_)) %>%
#   mutate(trialn = tidytext::reorder_within(trialn, max_ts, participant) %>% fct_rev()) %>%
#   ggplot(aes(occl_ts, trialn, group = trialn)) + geom_line(alpha = .4) +
#   geom_point(aes(x = occl_ts2), alpha = .7) +
#   facet_wrap(~participant, scales = "free_y") +
#   tidytext::scale_x_reordered() +
#   scale_y_discrete(breaks = "none") +
#   labs(y = "Trials", x = "Occlusion duration (s)") +
#   theme_bw() 
#   
# 
# occl_ts_saccades %>%
#   filter(participant != 8) %>%
#   arrange(participant, trial_number, occl_ts) %>%
#   group_by(participant) %>%
#   mutate(trialn = data.table::rleid(trial_number) %>% factor) %>%
#   group_by(participant, trialn) %>%
#   mutate(saccade = !is.na(seg_index),
#          cumulative_saccades = cumsum(!is.na(seg_index)),
#          saccade_freq = cumulative_saccades/occl_ts,
#          min_ts = min(occl_ts),
#          max_ts = max(occl_ts)) %>%
#   ungroup %>%
#   mutate(occl_ts2 = ifelse(saccade, occl_ts, NA_real_)) %>%
#   filter((saccade) | (occl_ts == max_ts) | (occl_ts == min_ts)) %>%
#   mutate(trialn = tidytext::reorder_within(trialn, max_ts, participant) %>% fct_rev()) %>%
#   ggplot(aes(occl_ts, trialn, color = saccade_freq)) +  geom_line(alpha = .4) +
#  geom_point(aes(x = occl_ts2), size = 3) +
#   facet_wrap(~participant, scales = "free_y") +
#   tidytext::scale_x_reordered() +
#   scale_y_discrete(breaks = "none") +
#   labs(y = "Trials", x = "Occlusion duration (s)") +
#   theme_bw() +
#   scale_color_distiller(palette = "Spectral", trans = "log")
  

# occl_ts_saccades %>%
#   filter(participant == 1) %>%
#   arrange(participant, trial_number, occl_ts) %>%
#   mutate(occl_bin = cut_width(occl_ts, .05, boundary = 0)) %>%
#   group_by(participant, trial_number, occl_bin) %>%
#   mutate(saccade = !is.na(seg_index),
#          saccades = sum(!is.na(seg_index))) %>%
#   group_by(participant, trial_number) %>%
#   mutate(cumulative_saccades = cumsum(saccades),
#          saccade_freq = cumulative_saccades/occl_ts,
#          min_ts = min(occl_ts),
#          max_ts = max(occl_ts)) %>%
#   mutate(trialn = factor(paste0(participant,"_",trial_number))) %>%
#   mutate(occl_ts2 = ifelse(saccade, occl_ts, NA_real_)) %>%
#   ungroup %>%
#   ggplot(aes(occl_bin, fct_reorder(trialn, max_ts) %>% fct_rev(), fill = saccades)) + 
#   geom_tile() +
#   facet_wrap(~participant) +
#   theme_bw() +
#   scale_fill_gradient2()


```



### Saccade amplitudes over time
```{r}

saccadetimes %>% 
  ggplot(aes(occl_ts, dist, 
             group = interaction(participant, trial_number), color = participant)) + 
  geom_point(alpha = .25) +
  facet_wrap(~participant) +
  geom_smooth(aes(occl_ts, dist, color = participant), inherit.aes = F,  
              method = "lm", se = F, linetype = "dashed") +
  theme_bw() +
  theme(legend.position = "none")

fit_dist <- lmer(dist ~ occl_ts + (occl_ts|participant/trial_number), data = saccadetimes)

summary(fit_dist)

broom.mixed::augment(fit_dist) %>% 
  ggplot(aes(occl_ts, dist, color = participant)) + 
  geom_point(alpha = .25) +
  geom_line(aes(occl_ts, .fitted, group = trial_number), alpha = .5) +
  facet_wrap(~participant) +
  theme_bw() +
  theme(legend.position = "none")


```

