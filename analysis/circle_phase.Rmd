---
title: "Circle phases"
output: 
  html_notebook:
    code_folding: hide
---

```{r setup}
library(arrow)
library(ggpubr)
library(tidyverse)
```

# Read data
```{r}
df <- arrow::read_feather("C:/Users/tuisku.tammi/Documents/GitHub/tuisku/phd/1stexp_analysis/data/segments.feather")


df <- df %>%
  select(participant, ts, conf, gazeX:target_y, is_visible:trial_number, gazeX_s:end_seg_class) %>%
  mutate(is_cue = if_else(signtype == "cue", 1, 0),
         is_target = if_else(signtype == "target", 1, 0),
         is_success = if_else(signtype == "success", 1, 0)) %>%   
  mutate(is_trial = (is_cue == 1) | (is_target == 1)) # is_trial => trial without response, query, feedback

df <- df %>%
  group_by(participant) %>%
  mutate(is_gap = (ts - lag(ts)) > 2,
         is_gap = replace(is_gap, row_number() == 1, FALSE)) %>%
  group_by(participant, is_gap) %>%
  arrange(participant, ts) %>%
  mutate(seg_fill = lag(begin_seg_class)) %>%
  mutate(seg_fill = if_else(is.na(seg_fill), end_seg_class, seg_fill)) %>%
  fill(seg_fill) %>%
  mutate(seg_fill = if_else(is_gap, NA_real_, seg_fill)) %>%
  ungroup 

```



### Tidy main data


```{r}

df <- df %>% 
  mutate(across(c(begin_seg_class, end_seg_class, seg_fill, segment_class_2), 
                ~recode(., `1` = "pursuit", `2` = "saccade", 
                        `3` = "pursuit", `4` = "pursuit"))) %>%
    mutate(target_class = case_when(is_target == 1 ~ "target",
                           (is_visible == 1) & (is_cue == 1) ~ "visible",
                           (is_visible == 0) & (is_cue == 1) ~ "hidden",
                           TRUE  ~ NA_character_) %>% 
             factor(levels = c("visible", "hidden", "target"))) %>%
    mutate(target_phase_R = atan2(target_x, target_y),
           gaze_phase_R = atan2(gazeX_s, gazeY_s),
           target_radius = sqrt((target_x)^2 + (target_y)^2),
           gaze_radius = sqrt((gazeX_s)^2 + (gazeY_s)^2),
           phase_diff = gaze_phase_R - target_phase_R,
           radius_diff = gaze_radius - target_radius,
           x_rel = gazeX_s - target_x,
           y_rel = gazeY_s - target_y) %>%
  arrange(participant, ts) 

```


Create occluded_trial and success_trial variables, mark 1st occluded block as practice
Note some erroneous trials like p8 trial 317 (due to missing data), hence the filter
```{r}

df <- df %>%
  mutate(trial_gap = is.na(trial_number)) %>%
  group_by(participant, trial_number) %>%
  mutate(trial_type = ifelse((mean(is_visible) == 1) & (trial_number < 300), 
                             "visible_trial", "occluded_trial"),
         success_trial = max(is_success)) %>%
  group_by(participant) %>%
  mutate(s1 = data.table::rleid(trial_gap) * !trial_gap, 
      s2 = (NA^!s1) * s1,
      block = match(s2, unique(na.omit(s2)))) %>%
  mutate(trial_type = if_else((trial_type == "occluded_trial") & (block == 2), "occluded_practice_trial", trial_type))

# check number of trials per block
df %>%
  group_by(participant, block, trial_type) %>%
  summarise(trials = n_distinct(trial_number, na.rm=T))


```

#### Extract segment info

begin_segment_index: index of the segment that begins at this timestamp


```{r}
# get launch/landing from df 
segment_durations <- df %>%
#  select(participant, block, ts, seg_fill) %>%
  group_by(participant) %>%
  arrange(participant, ts) %>%
  mutate(seg_index = data.table::rleid(seg_fill)) %>%
  group_by(participant, seg_index, seg_fill) %>%
  summarise(landing = max(ts), start_block = first(block), end_block = last(block)) %>%
  group_by(participant) %>%
  mutate(launch = lag(landing)) %>% ungroup %>% filter(!(start_block != end_block)) %>%
  rename(class = seg_fill) %>%
  select(-start_block, -end_block) %>%
  mutate(dur = landing - launch)

```

```{r fig.width=10}
# weird stuff
# segments <- df %>%
#   filter((!is.na(begin_seg_class)) | (!is.na(end_seg_class))) %>%
#   rename(begin_seg_index = begin_segment_index) %>%
#   arrange(participant, begin_seg_index) %>%
#   group_by(participant, block) %>%
#   mutate(end_seg_index = lag(begin_seg_index)) %>% 
#   ungroup %>%
#   mutate(across(ends_with("_seg_index"), as.character)) %>%
#   pivot_longer(cols = c(begin_seg_index, end_seg_index, begin_seg_class, end_seg_class),
#                names_to = c("timept", "var"),
#                values_to = "value",
#                names_pattern = "(.*)_seg_(.*)") %>%
#   spread(var, value) %>%
#   mutate(timept = recode(timept, begin = "launch", end = "landing")) %>% 
#   filter(!is.na(index)) %>%
#   arrange(participant, ts) %>%
#   relocate(participant, index, timept, class)
# 
# # merge consecutive segments
# segments <- segments %>%
#   group_by(participant, class) %>%
#   arrange(participant, class, index, desc(timept)) %>%
#   mutate(remove_seg = ((timept == "landing") & (ts == lead(ts))) | ((timept == "launch") & (ts == lag(ts)))) %>% 
#   mutate(index_old = index,
#          index = case_when((lag(remove_seg) == TRUE) & (!remove_seg) ~ lag(index_old, 3),
#                            remove_seg == F ~ index_old,
#                            T ~ NA_character_)) %>%
#   ungroup %>%
#   filter(remove_seg == F) %>%
#   arrange(participant, ts)

# durations
# segment_durations <- segments %>%
# #  filter(!is.na(trial_number)) %>%
#   select(participant:ts) %>% #filter(row_number() > 12395, index == 4275) %>% pull(ts)
#   spread(timept, ts) %>%
#   mutate(dur = landing - launch)

segment_durations %>%
  ggplot(aes(dur, fill=class)) +
  geom_density(alpha=.4) +
  facet_wrap(~participant, scales="free") +
  theme_bw()

```



#### Separate trial data  

**NOTE: trial_number now contains query, success, etc. The numbers are also different (used to start at 60 for circular trials). **

```{r}
df_trials <- df %>%
  filter(is_trial) %>%
  group_by(participant, trial_number) %>%
  mutate(trial_ts = ts - min(ts)) %>%
  ungroup %>%
  arrange(participant, trial_number, trial_ts)

```


# Circle task

## Success by phase

```{r}
df_trials %>% 
  filter(participant == 1, trial_number == 174) %>%
  ggplot(aes(target_x, target_y, color = target_phase_R)) + geom_path(size=3, lineend = "round") + 
  scale_color_gradient2() +
  theme_bw() +
  coord_fixed() + labs(title = "Values of phase variable", color = "")

```

```{r}
target_phases <- df_trials %>%
  filter(is_target == 1) %>%
  group_by(participant, trial_number, success_trial) %>%
  summarise(target_phase = mean(target_phase_R)) %>%
  ungroup %>%
  mutate(target_phase_bin = cut_interval(target_phase, 8)) %>% 
  group_by(target_phase_bin) %>%
  mutate(target_phase_bound = min(target_phase)) %>%
  group_by(participant, target_phase_bin, target_phase_bound) %>%
  summarise(success_rate = mean(success_trial),
            successes = sum(success_trial),
            trials = n()) %>%
  ungroup 

target_phases %>%
  ggplot(aes(target_phase_bound, success_rate)) + 
  geom_hline(aes(yintercept = .25), linetype = "dashed", alpha = .4) +  
  geom_col(alpha = .7) + 
  facet_wrap(~participant) +
  labs(x = "Phase (lower bound of bin)", y = "Success rate", title = "Participant-wise distributions of success rate by phase") +
  scale_y_continuous(labels = scales::percent) +
  scale_x_continuous(breaks = target_phases$target_phase_bound, 
                     labels = round(target_phases$target_phase_bound,1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


```

# Plot segmented data

**Segmentation is now done for full data.**

Visualising 1. raw time series and 2. gaze in xy coordinates as panel plots

```{r}
color_vals <- c( # actual colors used in the plot
                                "saccade" = "red", 
                                "pursuit" = "darkgreen", 
#                                "fixation" = "black",
                                "target" = "blue", 
                                "visible" = "lightblue",
                                "hidden" = "grey",
                                # placeholder values for legend titles
                                " " = "white")

color_breaks <- c("saccade", "pursuit", " ", "target","visible","hidden")

```


## Time series

Random sampling of time segments

n samples for visible / occluded timepoints --> windows of width 20s around them

TODO: Participant 8 bad data!

```{r}
times <- df %>%
  filter((participant != 8) | (ts < 99000), is_trial) %>%
  group_by(participant, is_visible) %>%
  slice_sample(n = 3) %>%
  ungroup %>%
  select(participant, ts)

```

```{r }

plot_segm_times <- function(sbj, ts_center) {

  rects <- df %>%
    filter(participant == sbj, between(ts, ts_center - 10, ts_center + 10), 
           !is.na(trial_number)) %>%
    arrange(ts) %>%
    group_by(target_class_id = data.table::rleid(target_class), target_class) %>% 
    summarise(xmin = min(ts),
              xmax = max(ts)) %>%
    ungroup %>%
    mutate(ymin = -20, ymax = 20)

    title <- paste("Participant", sbj)

  df %>%
    filter(participant == sbj, between(ts, ts_center - 10, ts_center + 10), 
           !is.na(trial_number)) %>%
    select(ts, gazeX, gazeY, gazeX_s, gazeY_s, seg_fill, target_class) %>%
    rename(segm_X = gazeX_s,
           segm_Y = gazeY_s,
           gaze_X = gazeX,
           gaze_Y = gazeY) %>%
    gather(var, value, gaze_X:segm_Y) %>%
    separate(var, into = c("var", "coord")) %>%
    spread(var, value) %>%
    ggplot() +
    geom_rect(data=rects, aes(xmin=xmin, ymin=ymin, xmax=xmax, ymax=ymax,
        fill=target_class), alpha = .4) +
    geom_path(aes(ts, gaze, color = "original gaze"), alpha = .8) +
    geom_path(aes(ts, segm, color = seg_fill, group=1), alpha = .8) +
    facet_grid(coord~., switch = "y") +
    labs(x = "time", title = title, colour = "") +
    scale_y_continuous(limits = c(-20, 20)) +
    theme_bw() +
    scale_color_manual(breaks=c(color_breaks, "original gaze"),
                       values = c(color_vals, "original gaze" = "darkgrey"),
                     drop = F)   + 
    scale_fill_manual(breaks=color_breaks,
                       values = color_vals,
                     drop = F)  +
    theme(strip.placement = "outside", 
          strip.background = element_blank())

}


```

```{r fig.width=14, fig.height=7, message=F}
segment_plots_times <- mapply(plot_segm_times, times$participant, times$ts, SIMPLIFY = F)
 
 
pdf("time_series_segments.pdf", width = 12, height = 7)
 invisible(lapply(segment_plots_times, print))
 dev.off()
```




Random sampling of trials

Sample visible and hidden trials


```{r}
set.seed(1)
trials <- df_trials %>% 
  filter((participant != 8) | (ts < 99000), is_trial, trial_type != "occluded_practice_trial") %>%
  group_by(participant, trial_number, trial_type) %>%
  summarise(trial_duration = max(ts) - min(ts)) %>% 
  group_by(participant, trial_type) %>%
  slice_sample(n = 3) %>% # n visible, n hidden trials per participant
  ungroup %>%
  arrange(participant, desc(trial_type))

```
## Trial plots

### Time series plot of trial

```{r }

plot_segm <- function(sbj, trialn) {
  

  rects <- df_trials %>%
    filter(participant == sbj, trial_number == trialn) %>%
    arrange(trial_ts) %>%
    group_by(trial_number, target_class) %>%
    summarise(xmin = min(trial_ts),
              xmax = max(trial_ts)) %>%
    ungroup %>%
    mutate(ymin = -20, ymax = 20)
  
    title <- paste0("Participant ", sbj, ", trial ", trialn)
  
    trialdur <- df_trials %>%
    filter(participant == sbj, trial_number == trialn) %>%
      summarise(trial_duration = max(trial_ts)) %>%
      pull(trial_duration)
  
  df_trials %>%
    filter(participant == sbj, trial_number == trialn) %>%
    select(trial_ts, gazeX, gazeY, gazeX_s, gazeY_s, seg_fill, target_class) %>%
    rename(segm_X = gazeX_s,
           segm_Y = gazeY_s,
           gaze_X = gazeX,
           gaze_Y = gazeY) %>%
    gather(var, value, gaze_X:segm_Y) %>%
    separate(var, into = c("var", "coord")) %>%
    spread(var, value) %>%
    ggplot() + 
    geom_rect(data=rects, aes(xmin=xmin, ymin=ymin, xmax=xmax, ymax=ymax, 
        fill=target_class, group=1), alpha = .4) +  
    geom_path(aes(trial_ts, segm, color = seg_fill, group=1), alpha = .8) +
    facet_grid(coord~., switch = "y") +
    labs(title = title, colour = "",  y = "", x = "Time from trial start (s)") +
    scale_y_continuous(limits = c(-20, 20)) +
    theme_bw() +
    scale_color_manual(breaks=c(color_breaks, "isochronic lines"),
                       values = c(color_vals, "isochronic lines" = "orange"),
                     drop = F)  + 
    scale_fill_manual(color_breaks,
                       values = color_vals,
                     drop = F) +
    coord_fixed(ratio = .05)  + 
#    guides(col = guide_legend(override.aes = list(shape = 15, size = 8))) +
    theme(strip.placement = "outside", 
          strip.background = element_blank())
    
}


```

```{r fig.width=14, fig.height=7, message=F}
segment_plots <- mapply(plot_segm, trials$participant, trials$trial_number, SIMPLIFY = F)

```

### Circular plot of trial

```{r}

plot_trial <- function(sbj, trialn) {

  isochronic_lines <- df_trials %>%
    filter(participant == sbj, trial_number == trialn) %>%
    mutate(across(c(target_x, target_y, gazeX_s, gazeY_s), .names = "{col}_segm")) %>%
    slice(seq(1, n(), 100)) %>%
    select(ends_with("segm")) %>%
    rename(gaze_x_segm = gazeX_s_segm, gaze_y_segm = gazeY_s_segm) %>%
    rownames_to_column() %>%
    gather(var, value, -rowname) %>%
    separate(var, into = c("var", "coord"), extra = "drop") %>%
    spread(coord, value) %>%
    arrange(rowname, desc(var)) 
  
    title <- paste0("Participant ", sbj, ", trial ", trialn)
  
  p <- df_trials %>%
    filter(participant == sbj, trial_number == trialn) %>%
    ggplot() + 
    geom_path(aes(target_x, target_y, color = target_class, group=1), 
              alpha = .8, show.legend = F) +
    geom_line(data = isochronic_lines, aes(x, y, group = rowname, color = "isochronic lines"), 
              linetype = "dashed", inherit.aes = F) +
    geom_path(aes(gazeX_s, gazeY_s, color = seg_fill, group=1), 
              alpha = 1, inherit.aes = F) +
    geom_point(aes(0, 0, color = " "), alpha = 0) +
    labs(colour = "", title = title) +
    coord_fixed() +
    theme_bw()  +
    scale_y_continuous(limits = c(-16, 16)) +
    scale_x_continuous(limits = c(-16, 16)) +
    scale_color_manual(breaks=c(color_breaks, "isochronic lines"),
                       values = c(color_vals, "isochronic lines" = "orange"),
                     drop = F) # + 
  #   scale_fill_manual(breaks=color_breaks[4:7],
  #                      values = color_vals[4:7],
  #                    drop = F)  + 
  # guides(fill = guide_legend(override.aes = list(shape = 15, size = 8)))
  
  p
  
}


```



```{r fig.width=12}

trialplots <- mapply(plot_trial, trials$participant, trials$trial_number, SIMPLIFY = F)


```

Plot time series and circles in grid


```{r fig.height=7, fig.width=12}

panel_plots <- lapply(1:60, function(i) {
  ggarrange(trialplots[[i]], segment_plots[[i]] + labs(title = ""), common.legend = T, legend = "right")
})


pdf("circle_ts_panelplots.pdf", width = 12, height = 7)
invisible(lapply(panel_plots, print))
dev.off()

```

# Gaze distribution relative to target

(rotated around circle centerpoint and vertical aligned with radius to target) = ???

For segmented data; saccade launch & landing points

1st saccades after occlusion removed

```{r}
segments <- segment_durations %>%
  select(-dur) %>%
  gather(timept, ts, launch, landing) %>%
  left_join(df, by = c("participant", "ts"))

saccades <- segments %>%
  filter(class == "saccade", is_trial) %>%
  group_by(participant, trial_number) %>%
  mutate(trial_ts = ts - min(ts)) %>%
  group_by(participant, trial_number, is_visible) %>%
  mutate(occl_ts = if_else(!is_visible, ts - min(ts), NA_real_),
         first_saccade = if_else((!is_visible) & (seg_index == min(seg_index)), T, F)) %>%
  arrange(participant, seg_index, desc(timept)) %>%
  filter(!first_saccade) %>% # remove the first saccade of each occlusion: the one with the smallest index
  ungroup %>%
  arrange(participant, trial_number, trial_ts) %>%
  mutate(is_visible_cue = if_else(is_visible, "visible", "hidden"))

```


### Participant-wise

Make axis limits identical

```{r }

saccades %>%
#  filter(abs(x_rel) < 20, abs(y_rel) < 20) %>% # TODO: remove this filter after fixing conf
  filter(is_cue == 1, trial_type == "occluded_trial") %>%
  ggplot(aes(x_rel, y_rel, colour = timept)) + geom_point(alpha = .1) +
  facet_wrap(participant~is_visible_cue, ncol = 6) +
  geom_vline(aes(xintercept = 0), alpha = .5) +
  geom_hline(aes(yintercept = 0), alpha = .5) +
  scale_x_continuous(limits = c(-25, 25)) +
  scale_y_continuous(limits = c(-25, 25)) +
  labs(title = "Saccade launch/landing points relative to hidden/visible target (cue)", 
       subtitle = "Participant-wise distributions, occluded trials",
       colour = "", x = "x", y = "y") +
  theme_bw() +
  coord_fixed() + 
  guides(colour = guide_legend(override.aes = list(alpha = 1)))


```



```{r fig.width=10}
saccades %>% 
  filter(is_cue == 1, !is.na(timept), trial_type == "occluded_trial") %>%
  ggplot(aes(phase_diff, fill = timept)) + 
  geom_histogram(binwidth=.05, position = "identity", alpha = .4) +
  scale_x_continuous(limits = c(-1.5,1.5)) +
  geom_vline(aes(xintercept = 0), alpha = .5) +
  facet_wrap(participant~is_visible_cue, scales = "free_y", ncol=6)  +
  labs(title = "Phase difference between saccades and hidden/visible object",
       subtitle = "Participant-wise distributions, occluded trials", fill = "") +
  theme_bw() 
```

```{r fig.width=10}
saccades %>% 
  filter(is_cue == 1, !is.na(timept), trial_type == "occluded_trial") %>%
  ggplot(aes(radius_diff, fill = timept)) + 
  geom_histogram(binwidth=1, position = "identity", alpha = .4) +
  scale_x_continuous(limits = c(-13.5,13.5)) +
  geom_vline(aes(xintercept = 0), alpha = .5) +
  facet_wrap(participant~is_visible_cue, scales = "free_y", ncol=6)   +
  labs(title = "Radius difference between saccades and hidden/visible object",
       subtitle = "Participant-wise distributions, occluded trials", fill = "") +
  theme_bw() 

```

### Average

```{r}
saccades %>% 
  filter(is_cue == 1, !is.na(timept), trial_type == "occluded_trial") %>%
  ggplot(aes(phase_diff, fill = timept)) + 
  geom_histogram(binwidth=.08, position = "identity", alpha = .4) +
  scale_x_continuous(limits = c(-2,2)) +
  geom_vline(aes(xintercept = 0), alpha = .5) +
  facet_wrap(~is_visible_cue, scales = "free_y", ncol=2)  +
  labs(title = "Phase difference between saccades and hidden/visible object",
       subtitle = "All participants, occluded trials") +
  theme_bw() 
```


```{r message=F}
saccades %>% 
  filter(is_cue == 1, !is.na(timept), trial_type == "occluded_trial") %>%
  ggplot(aes(radius_diff, fill = timept)) + 
  geom_histogram(binwidth=1, position = "identity", alpha = .4) +
  scale_x_continuous(limits = c(-13.5,13.5)) +
  geom_vline(aes(xintercept = 0), alpha = .5) +
  facet_wrap(~is_visible, scales = "free_y", ncol=2)   +
  labs(title = "Radius difference between saccades and hidden/visible target (cue)",
       subtitle = "All participants, occluded trials") +
  theme_bw() 
```


# Gaze distribution relative to target (at target reappearance)

### Participant-wise

```{r fig.width = 10, fig.height=15}
df_trials %>%
  filter(is_target == 1, trial_type == "occluded_trial") %>% 
  group_by(participant, trial_number, success_trial) %>%
  slice(1) %>%
  ungroup %>%
  mutate(success_trial = ifelse(success_trial == 1, "correct", "false")) %>%
  ggplot(aes(x_rel, y_rel)) + geom_point(alpha = .2) +
  facet_wrap(participant~success_trial, ncol = 4) +
  geom_vline(aes(xintercept = 0), alpha = .5) +
  geom_hline(aes(yintercept = 0), alpha = .5) +
  scale_x_continuous(limits = c(-20, 20)) +
  scale_y_continuous(limits = c(-20, 20)) +
  labs(title = "Gaze position relative to object (at target appearance)", 
       subtitle = "Participant-wise distributions, occluded trials",
       colour = "", x = "x", y = "y") +
  theme_bw() +
  coord_fixed()

```

```{r fig.width = 10}
df_trials %>%
  filter(is_target == 1, trial_type == "occluded_trial") %>%
  group_by(participant, trial_number, success_trial) %>%
  slice(1) %>%
  ungroup %>%
  mutate(success_trial = ifelse(success_trial == 1, "correct", "false")) %>%
  ggplot(aes(phase_diff)) + 
  geom_histogram(binwidth=.15, alpha = .6) +
  scale_x_continuous(limits = c(-2,2)) +
  geom_vline(aes(xintercept = 0), alpha = .5) +
  facet_wrap(~participant, ncol = 5, scales = "free_y") +
  labs(title = "Phase difference between gaze and object (at target appearance)",
       subtitle = "Participant-wise distributions, occluded trials") +
  theme_bw() 


```

```{r }
df_trials %>%
  filter(is_target == 1) %>%
  group_by(participant, trial_number, success_trial) %>%
  slice(1) %>%
  ungroup %>%
  mutate(success_trial = ifelse(success_trial == 1, "correct", "false")) %>%
  ggplot(aes(radius_diff, fill = trial_type)) + 
  geom_histogram(binwidth=1, position = "identity", alpha = .6) +
  scale_x_continuous(limits = c(-20,20)) +
  geom_vline(aes(xintercept = 0), alpha = .5) +
  facet_wrap(participant~success_trial, ncol = 6, scales = "free_y") +
  labs(title = "Radius difference between gaze and target (at target reappearance)",
       subtitle = "Participant-wise distributions, occluded trials") +
  theme_bw() 

```

#### Success rate by distance

```{r message=F, fig.width=9, fig.height=7}
abs_dist <- df_trials %>%
  filter(is_target == 1) %>%
  group_by(participant, trial_number, success_trial, trial_type) %>%
  slice(1) %>%
  ungroup %>%
  mutate(abs_dist = abs(sqrt((gazeX_s - target_x)^2 + (gazeY_s -target_y)^2))) %>%
  mutate(abs_dist_bin = cut_number(abs_dist, 4)) %>%
  group_by(abs_dist_bin) %>%
  mutate(abs_dist_bound = min(abs_dist)) %>%
  group_by(participant, trial_type, abs_dist_bin, abs_dist_bound) %>%
  summarise(success_rate = mean(success_trial),
            successes = sum(success_trial),
            trials = n()) %>%
  ungroup 

abs_dist %>%
  mutate(correct_trials = paste0(successes, '/', trials)) %>%
  ggplot(aes(abs_dist_bound, success_rate)) + 
  geom_hline(aes(yintercept = .25), linetype = "dashed", alpha = .4) +  
  geom_col(alpha = .7) + 
  facet_wrap(trial_type~participant) +
  labs(title = "Participant-wise success rates by distance of gaze from target (at target reappearance)", 
       x = "Absolute distance (lower bound of bin)", y = "Success rate") +
  scale_y_continuous(labels = scales::percent, limits = c(0,1.05)) +
  scale_x_continuous(breaks = abs_dist$abs_dist_bound, labels = round(abs_dist$abs_dist_bound,2)) +
  geom_text(aes(label = correct_trials), vjust = -.2) +
  theme_bw()
```

```{r fig.width=10}
# df %>%
#   filter(is_target == 1) %>%
#   group_by(participant, trial_number, success_trial) %>%
#   slice(1) %>%
#   ungroup %>%
#   mutate(abs_dist = abs(sqrt((gazeX_s - target_x)^2 + (gazeY_s -target_y)^2))) %>%
#   arrange(participant, abs_dist) %>% 
#   group_by(participant) %>%
#   mutate(cum_successes = cumsum(success_trial),
#          cum_trials = row_number(),
#         cum_successrate = cum_successes/cum_trials) %>%
#   mutate(correct_trials = paste0(cum_successes, '/', cum_trials)) %>%
#   ggplot(aes(abs_dist, cum_successrate)) + geom_point() +
#   geom_hline(aes(yintercept = .25), linetype = "dashed", alpha = .4) +    
#   facet_wrap(~participant) +
#   labs(x = "Absolute distance", y = "Cumulative success rate", 
#        title = "Cumulative success rates by distance of gaze from target (at target reappearance)") + 
#   scale_y_continuous(labels = scales::percent, limits = c(0,1.05)) +
#   theme_bw()
# 
# df %>%
#   filter(is_target == 1) %>%
#   group_by(participant, trial_number, success_trial) %>%
#   slice(1) %>%
#   ungroup %>%
#   mutate(abs_dist = abs(sqrt((gazeX_s - target_x)^2 + (gazeY_s -target_y)^2))) %>%
#   arrange(participant, abs_dist) %>% 
#   group_by(participant) %>%
#   mutate(abs_dist_bin = cut_number(abs_dist, 6)) %>%
#   group_by(abs_dist_bin) %>%
#   mutate(abs_dist_bound = min(abs_dist)) %>%
#   group_by(participant, abs_dist_bin, abs_dist_bound) %>%
#   summarise(success_rate = mean(success_trial),
#             successes = sum(success_trial),
#             trials = n()) %>%
#   arrange(participant, abs_dist_bound) %>%
#   group_by(participant) %>%
#   mutate(cum_successes = cumsum(successes),
#          cum_trials = cumsum(trials),
#         cum_successrate = cum_successes/cum_trials) %>%
#   mutate(correct_trials = paste0(cum_successes, '/', cum_trials)) %>% 
#   ggplot(aes(abs_dist_bound, cum_successrate)) + geom_point() +
#   geom_hline(aes(yintercept = .25), linetype = "dashed", alpha = .4) +    
#   facet_wrap(~participant) +
#   labs(x = "Absolute distance (lower bound of bin)", y = "Cumulative success rate", 
#        title = "Success rate", subtitle = "Participants have different bin widths") +
#   scale_y_continuous(labels = scales::percent, limits = c(0,1.05)) +
#   geom_text(aes(label = trials), vjust = -.2) +
#   theme_bw() 

```

# Tracking behaviour (pursuits/fixations)

pursuit parameters and velocity-matching during occluded tracking

### Duration of pursuits

```{r fig.width=11}
segment_durations %>%
  filter(target_class %in% c('visible', 'hidden'), class %in% c("fixation", "pursuit"), 
         trial_type == "occluded_trial") %>% # during target tracking
  ggplot(aes(dur, fill=target_class)) + 
  geom_density(alpha=.4) +
#    geom_histogram(alpha=.4, binwidth = .02) + 
  facet_wrap(~participant, scales = "free_y") +
  labs(title = "Pursuit/fixation durations", 
       subtitle = "Participant-wise distributions, occluded trials",
       x = "Duration (s)") +
  theme_bw()

```

