---
title: "1st exp results"
output: 
  html_notebook:
    code_folding: hide
    toc: yes
---

```{r setup, include=F}
library(ggpubr)
library(tidyverse)
library(lme4)
library(lmerTest)
library(broom.mixed)
```

```{r include=F}
df_trials <- readRDS('df_trials.RDS')
saccades <- readRDS('saccades.RDS')

```

```{r colors}
color_vals <- c( # actual colors used in the plot
                                "saccade" = "red", 
                                "pursuit" = "darkgreen", 
                                "target" = "blue", 
                                "visible" = "deepskyblue",
                                "hidden" = "darksalmon",
                                # placeholder values for legend titles
                                " " = "white")

color_breaks <- c("saccade", "pursuit", " ", "target","visible","hidden")

```



```{r wrangling, message=F}
  
df_dur <- df_trials %>%
  filter(signtype == "cue", trial_type == "occluded_trial", 
         target_class %in% c("visible", "hidden")) %>%
  spread(target_class, ts) %>%
  group_by(participant, trial_number) %>%
  summarise(visible = max(visible, na.rm=T) - min(visible, na.rm=T),
            hidden = max(hidden, na.rm=T) - min(hidden, na.rm=T)) %>%
  ungroup %>%
  pivot_longer(cols = c("visible", "hidden"),
               names_to = "target_class",
               values_to = "duration") %>%
  filter(!is.infinite(duration))

saccadetimes_full <- saccades %>%
  filter(signtype == "cue", trial_type == "occluded_trial") %>%
  group_by(participant, seg_index, target_class) %>%
  filter(n_distinct(timept) == 2) %>% 
  arrange(participant, seg_index, desc(timept)) %>%
  group_by(participant, seg_index) %>%
  mutate(dist = sqrt((gazeX_s - lag(gazeX_s))^2 + (gazeY_s - lag(gazeY_s))^2) %>% lead,
         phasedist = (unwrap_gaze_phase_R - lag(unwrap_gaze_phase_R)) %>% lead) %>%
  filter(timept == "launch")  %>%
  ungroup %>%
  mutate(cond_ts = if_else(target_class == "hidden", occl_ts, trial_ts)) %>%
  select(participant, seg_index, cond_ts, dist, phasedist, trial_number, target_class) 

full_ts_saccades <- df_trials %>%
  filter(signtype == "cue", trial_type == "occluded_trial") %>%
  mutate(cond_ts = if_else(target_class == "hidden", occl_ts, trial_ts)) %>%
  select(participant, trial_number, target_class, cond_ts) %>%
  full_join(saccadetimes_full, by = c("participant", "trial_number", "target_class", "cond_ts"))
  

trial_saccades <- saccadetimes_full %>%
  group_by(participant, trial_number, target_class) %>%
  summarise(saccades = n_distinct(seg_index),
            median_dist = median(dist),
            median_phasedist = median(phasedist)) %>%
  ungroup %>%
  left_join(df_dur, by = c("participant", "trial_number", "target_class")) %>%
  mutate(freq = saccades/duration)


```

## Saccade frequency

### Visible vs. occluded target: trial-level frequencies

Trial-level frequency (saccades/second) is calculated as the sum of saccades divided by the duration of (visible/hidden) time segment.  

Some outliers: e.g. participant 8, trial 450 during occlusion (frequency 14.3; 1 saccade during a period of 0.07 s).  

```{r fig.width=10, fig.height=10}
trial_saccades %>% 
  gather(var, value, saccades:freq) %>%
  mutate(var = factor(var, levels = c("freq", "saccades", "duration"),
                      labels = c("Frequency (saccades/s)", "Saccade count", "Duration of visible/hidden cue (s)"))) %>%
  ggplot(aes(participant, value, fill = target_class %>% fct_rev)) + geom_boxplot(alpha = .7) +
  facet_wrap(~var, scales = "free", ncol = 1, strip.position = "left") +
  theme_bw() +
  scale_fill_manual(values = color_vals) +
  labs(title = "Saccade frequency: participant-wise distributions", y = "", fill = "")  +
    theme(strip.placement = "outside", 
          strip.background = element_blank())


```


### Saccade frequency over time

```{r fig.width=10, fig.height=7}

trial_saccades %>%
  ggplot(aes(duration, freq, color = target_class)) +
  geom_point(alpha = .4) +
  facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " "))  +
  theme_bw() +
  labs(title = "Trial-level saccade frequencies over time", y = "Frequency (saccades/s)",
       x = "Duration of visible/hidden cue (s)", color = "") +
  scale_color_manual(values = color_vals) +
  guides(color = guide_legend(override.aes = list(alpha = 1, size = 3)))

```


### Within trials


```{r fig.width=10, fig.height=7}

saccadetimes_full %>% 
  arrange(participant, target_class, trial_number, cond_ts) %>%
  group_by(participant, target_class, trial_number) %>%
  mutate(cumulative_saccades = cumsum(!is.na(seg_index))) %>%
  ungroup %>%
  ggplot(aes(cond_ts, cumulative_saccades,
             group = interaction(participant, target_class, trial_number), color = target_class)) +
  geom_line(alpha = .2) +
  facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
  labs(title = "Saccade count over time",
       y = "Cumulative saccade count", x = "Duration of visible/hidden cue (s)", color = "") +
  geom_smooth(aes(cond_ts, cumulative_saccades, color = target_class), inherit.aes = F,
              method = "lm", se = F, linetype = "dashed") +
  theme_bw()  +
  scale_color_manual(values = color_vals)



csaccades <- saccadetimes_full %>%
  arrange(participant, target_class, trial_number, cond_ts) %>%
  group_by(participant, target_class, trial_number) %>%
  mutate(cumulative_saccades = cumsum(!is.na(seg_index))) %>%
  ungroup

zero_saccades <- csaccades %>%
  distinct(participant, target_class, trial_number) %>%
  anti_join(csaccades %>% filter(cond_ts == 0), by = c("participant", "target_class", "trial_number")) %>%
  mutate(cond_ts = 0,
         cumulative_saccades = 0)

csaccades %>%
  full_join(zero_saccades, by = c("participant", "cond_ts", "trial_number", "target_class", "cumulative_saccades")) %>%
  arrange(participant, target_class, cond_ts) %>%
  # group_by(participant) %>%
  # mutate(slope = round(lm(cumulative_saccades ~ cond_ts)$coefficients[2], 2)) %>%
  # ungroup %>%
  # mutate(participant2 = participant) %>%
  # mutate(participant = paste0(participant, " (slope ", slope, ")") %>% factor) %>%
  # mutate(participant = fct_reorder(participant, as.numeric(participant2))) %>%
  ggplot(aes(cond_ts, cumulative_saccades,
             group = interaction(participant, target_class, trial_number), color = target_class)) +
  geom_line(alpha = .2) +
  facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
  labs(title = "Saccade count over time (zero saccades included)",
       y = "Cumulative saccade count", x = "Duration of visible/hidden cue (s)", color = "") +
  geom_smooth(aes(cond_ts, cumulative_saccades, color = target_class), inherit.aes = F,
              method = "lm", se = F, linetype = "dashed") +
  theme_bw()  +
  scale_color_manual(values = color_vals)


```

In the plot below, cumulative frequency has been calculated from the cumulative sum of *saccades per trial* (saccade count scaled by n of trials at each timepoint).  

```{r fig.width=10.5, fig.height=7, message=F}
# occl_ts_saccades %>%
#   mutate(occl_bin = cut_width(occl_ts, 1/50), boundary = 0) %>%
#   group_by(participant, occl_bin) %>%
#   summarise(saccades = sum(!is.na(seg_index)),
#             trials = n_distinct(trial_number),
#             occl_ts_bound = max(occl_ts)) %>%
#   arrange(participant, occl_ts_bound) %>%
#   mutate(saccades_per_trial = saccades / trials, # scale count by n of trials
#          cumulative_saccades = cumsum(saccades_per_trial),
#          cs_freq = cumulative_saccades / occl_ts_bound) %>% 
#   ggplot(aes(occl_ts_bound, cs_freq, color = participant)) + #geom_path(size=1, alpha = .7) +
#   geom_point(aes(size=trials)) +
#   facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
#   labs(title = "Saccade frequency over time",
#        y = "Cumulative frequency (saccades/s)", x = "Occlusion duration (s)") +
#   theme_bw() + scale_size("Number of trials", range = c(0.01, 3), breaks = c(10,35,60)) + guides(color = F) +
#   theme(legend.position = "bottom")

# this df has "all timestamps" (also the ones without saccades)
full_ts_saccades %>%
  mutate(ts_bin = cut_width(cond_ts, 1/60), boundary = 0) %>%
  group_by(participant, target_class, ts_bin) %>%
  summarise(saccades = sum(!is.na(seg_index)),
            trials = n_distinct(trial_number),
            ts_bound = max(cond_ts)) %>%
  arrange(participant, target_class, ts_bound) %>%
  mutate(saccades_per_trial = saccades / trials, # scale count by n of trials
         cumulative_saccades = cumsum(saccades_per_trial),
         cs_freq = cumulative_saccades / ts_bound) %>% 
  ggplot(aes(ts_bound, cs_freq, size = trials, color = target_class)) + #geom_path(size=1, alpha = .7) +
  geom_point(alpha = .3) +
  facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
  labs(title = "Saccade frequency over time",
       y = "Cumulative frequency (saccades/s)", x = "Duration of visible/hidden cue (s)", color = "") +
  theme_bw() + scale_size("Number of trials", range = c(0.01, 3), breaks = c(10,35,60)) + 
  theme(legend.position = "bottom") +
  scale_color_manual(values = color_vals) +
  guides(color = guide_legend(override.aes = list(alpha = 1, size = 3)))


```


## Saccade amplitude

```{r fig.width=10, fig.height=7}

saccadetimes_full %>%
  ggplot(aes(participant, dist, fill = target_class)) + geom_boxplot() +
  theme_bw() +
  scale_fill_manual(values = color_vals) +
  scale_y_continuous(limits = c(0, 20)) +
  labs(title = "Saccade amplitude: participant-wise distributions", y = "Amplitude (degrees)", fill = "")  +
    theme(strip.placement = "outside", 
          strip.background = element_blank())



```


```{r fig.width=10, fig.height=7}
saccadetimes_full %>% 
  ggplot(aes(cond_ts, dist, 
             group = interaction(participant, trial_number), color = target_class)) + 
  geom_point(alpha = .2) +
  facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
  labs(title = "Saccade amplitude over time", 
       y = "Amplitude (degrees)", x = "Duration of visible/hidden cue (s)", color = "") +
  theme_bw()  +
  scale_color_manual(values = color_vals) +
  guides(color = guide_legend(override.aes = list(alpha = 1, size = 3)))

```

### Scatter plot: frequency vs. amplitude

Trial-level saccade frequency vs. median saccade amplitude, all participants pooled. Points with black border (connected by thin line for each participant) are participant medians.  

```{r}

trial_saccades %>%
  group_by(participant, target_class) %>%
  mutate(freq_part = median(freq),
         dist_part = median(median_dist)) %>%
  ggplot(aes(freq, median_dist, color = target_class)) + 
  geom_point(alpha = .2)  +
  geom_point(aes(freq_part, dist_part, fill = target_class), color = "black", size = 2, shape = 21, show.legend = F) +
  geom_line(aes(freq_part, dist_part, group = participant), inherit.aes = F, alpha = .2) +
  theme_bw() +
  scale_color_manual(values = color_vals) +
  scale_fill_manual(values = color_vals) +
  guides(color = guide_legend(override.aes = list(alpha = 1, size = 3))) +
  scale_y_continuous(limits = c(0,20)) +
  scale_x_continuous(limits = c(0,7)) +
  labs(x = "Frequency (saccades/s)", y = "Median saccade amplitude", color = "")

```

### Phase angle covered by saccades

```{r}

saccadetimes_full %>%
  summarise(negatives = mean(phasedist < 0)) # 5.7 % of saccades go in the "wrong" direction

```

```{r fig.width=10, fig.height=7}

saccadetimes_full %>%
  ggplot(aes(participant, phasedist, fill = target_class)) + geom_boxplot() +
  theme_bw() +
  scale_fill_manual(values = color_vals) +
  labs(title = "Phase angle covered by saccades: participant-wise distributions", 
       y = "Phase change (radians)", fill = "")  +
    theme(strip.placement = "outside", 
          strip.background = element_blank())



```


NEXT: OVER TIME