---
title: "1st paper figures"
output: html_notebook
---

```{r setup}
library(ggpubr)
library(pastecs)
library(zoo)
library(ggsci)
library(scales)
library(RColorBrewer)
library(viridisLite)
library(tidyverse)

df_trials <- readRDS('df_trials.RDS')
saccades <- readRDS('saccades.RDS')
seg_data <- readRDS('saccade_pursuit_full.rds')
int_data <- readRDS('saccade_pursuit_int.rds')
trial_saccades <- readRDS('trial_saccades.rds')

sddata <- data.table::fread('std_dump.csv.gz') # R.utils needed

```


Use the Helvetica font.  
Use approximately 10-point type for axis numbers, and 12-point type for axis labels.  
The type should be about the size of type in the body text, when the figure is created at the desired size.  
Do not use boldface.  
Do not use too wide a range of font sizes (less than a range of 8 points).  
Do not use 3D shapes for 2D data.  
Do not use bar charts when line graphs will do.  
Do not place a title at the top of the figure; this should go in the figure caption.  
Do not draw lines or shadows around the outside of the figure.  
Use color to distinguish data series, or for other useful didactic purposes, but not for decoration.  
Capitalize the first letter of the first word in the axis labels. 
If the axis labels include units, place them in parentheses.  
Avoid repeating axis labels in multi-panel figures.  
Figures should be placed in the manuscript after the paragraph in which it is first mentioned. 

```{r plot_specs}
# colors 
# separate colors for: 
# 1. participants: (d3 palette (10/20) OR) viridis default palette


# 2. gaze: saccade/pursuit: a pair from d3-10

# 3. object: hidden/visible/target: a triplet from d3-10/20

# 4. saccade launch/landing points

scales::show_col(pal_d3("category10")(10))
scales::show_col(pal_d3("category20")(20))

show_col(viridis_pal()(30))
show_col(viridis_pal(direction = -1)(10))

scales::show_col(pal_npg("nrc")(9))
scales::show_col(pal_lancet("lanonc")(10))

display.brewer.all(colorblindFriendly = TRUE)


# saccade = red, pursuit = blue, visible = black, hidden = gray
color_vals <- c( # actual colors used in the plot
                                "Gaze" = "white",
                                "Saccade" = "#D62728FF", # '#DC0000FF', 
                                "Smooth pursuit" =  "#0088b7", #"#41698DDF", #'darksalmon', 
                                "Object" = "white",
                                "Visible" = "black",
                                "Hidden" = "grey", 
                                "Target" = "black",
                                " " = "white")

# color_vals <- c( # actual colors used in the plot
#                                 "Gaze" = "white",
#                                 "Saccade" = "#D62728FF", 
#                                 "Smooth pursuit" =  "#FF7F2EFF", 
#                                 "Object" = "white",
#                                 "Visible" = "#31688EFF",
#                                 "Hidden" = "#91D1C2FF", 
#                                 "Target" = "#31588EFF",
#                                 " " = "white")
#
color_breaks <- c("Gaze", "Saccade", "Smooth pursuit", " ", "Object","Visible","Hidden", " ", " ")

# other specs

jov_theme <- theme_classic() + #base_family = "Helvetica"
  theme(legend.background = element_rect(fill = "transparent", colour = NA),
        legend.box.background = element_rect(fill = "transparent", colour = NA),
        axis.text=element_text(size=10), 
        axis.title=element_text(size=12))

```

```{r}

#PHASE FORMATTER (radians -> turns)

formatterphase <- function(x){ 
    x / (2*pi)
}

# add this to plot
 scale_y_continuous(labels = formatterphase, breaks = seq(-2, 2, by = .25)*2*pi)
  
df_trials <- df_trials %>% 
    mutate(target_class = str_to_title(target_class),
           seg_fill = recode(seg_fill, "pursuit" = "Smooth pursuit", "saccade" = "Saccade")) 
```


## 1 Illustrative time series

### 1a. screen x-y, saccades + pursuits

```{r}
#TODO fix legend titles by extracting (to match saccade freq fig)

plot_trial <- function(sbj, trialn) {

  #isochronic lines at the ends of segments
isochronic_ts <- df_trials %>%
    filter(participant == sbj, trial_number == trialn) %>%
    group_by(data.table::rleid(seg_fill)) %>%
    filter(ts == max(ts)) %>% 
    ungroup %>% pull(trial_ts)


# can't see number 3 and 9 -> adjust. make sure this is visible!!
isochronic_ts[3] <- isochronic_ts[3] - 0.04198366


isochronic_lines <- df_trials %>%
   filter(participant == sbj, trial_number == trialn) %>%
    mutate(across(c(target_x, target_y, gazeX_s, gazeY_s), .names = "{col}_segm")) %>%
    filter(round(trial_ts,6) %in% round(isochronic_ts[1:8],6)) %>%
    select(ends_with("segm")) %>%
    rename(gaze_x_segm = gazeX_s_segm, gaze_y_segm = gazeY_s_segm) %>%
    rownames_to_column() %>%
    gather(var, value, -rowname) %>%
    separate(var, into = c("var", "coord"), extra = "drop") %>%
    spread(coord, value) %>%
    arrange(rowname, desc(var)) 



  
curve_df <- df_trials %>%
  filter(participant == sbj, trial_number == trialn) %>%
  slice(1:45)

df_trials %>%
    filter(participant == sbj, trial_number == trialn) %>%
    mutate(target_class = factor(target_class, levels = c("Object", "Visible", "Hidden", "Target"))) %>%
    mutate(seg_fill = factor(seg_fill, levels = c("Gaze", "Smooth pursuit", "Saccade"))) %>%
    mutate(seg_id = data.table::rleid(seg_fill)) %>%
    ggplot() + 
    geom_path(aes(target_x, target_y, color = target_class, group=target_class), 
              alpha = 1, size =1, linejoin = "bevel") +
    geom_line(data = isochronic_lines, aes(x, y, group = rowname), linetype = "dashed",
              inherit.aes = F) +
    geom_path(aes(gazeX_s, gazeY_s, color = seg_fill, group=1), 
              alpha = 1, inherit.aes = F, size = 1, linejoin = "bevel", lineend = "round") +
    geom_point(aes(0, 0, color = " "), alpha = 0, inherit.aes = F, show.legend = F) +
#    geom_curve(aes(x = target_x1 + 2, y = target_y1, 
#                   xend = target_x2 + 2, yend = target_y2), data = curve_df, 
#                   curvature = -0.15) +
    geom_path(aes(target_x, target_y - 2), data = curve_df, arrow = arrow(length = unit(0.3, "cm"))) +
    labs(colour = "", x = "X (degrees)", y = "Y (degrees)") +
    coord_fixed() +
    scale_y_continuous(limits = c(-16, 16)) +
    scale_x_continuous(limits = c(-16, 16)) +
    scale_color_manual(breaks=c(color_breaks),
                       values = c(color_vals),
                     drop = F) + 
  guides(color = guide_legend(override.aes = list(alpha = .6))) +
    jov_theme

}

# a trial with occlusion, saccades & pursuits; less than one full circle (for clarity); phase/radius offset (for illustration)

circ_trials <- df_trials %>%
  filter(trial_type == "occluded_trial") %>%
  group_by(participant, trial_number) %>%
  filter(between(max(ts) - min(ts), 2.5, 3.5)) %>%
  distinct(participant, trial_number)



```

```{r}
(trial_circ <- plot_trial(8, 393))

```
# 1b. x-y time series

```{r}
occlusion_starts <- df_trials %>%
  group_by(participant, trial_number) %>%
  filter(occl_ts == 0) %>%
  select(participant, trial_number, trial_ts) %>%
  rename(occl_start = trial_ts)


plot_segm_xy <- function(sbj, trialn) {

  
  xcoord <- df_trials %>%
    full_join(occlusion_starts) %>%
    mutate(trial_ts = trial_ts - occl_start) %>%
    filter(participant == sbj, trial_number == trialn) %>%
    mutate(target_class = factor(target_class, levels = c("Object", "Visible", "Hidden", "Target"))) %>%
    mutate(seg_fill = factor(seg_fill, levels = c("Gaze", "Smooth pursuit", "Saccade"))) %>%
    mutate(seg_id = data.table::rleid(seg_fill)) %>%
    ggplot() + 
#    geom_rect(data=rects, aes(xmin=xmin, ymin=ymin, xmax=xmax, ymax=ymax, 
#        fill=target_class, group=1), alpha = .4) +  
    geom_path(aes(trial_ts, target_x, color = target_class, group=target_class), 
              alpha = 1, size = 1) +
    geom_path(aes(trial_ts, gazeX_s, color = seg_fill, group=1), size = 1, alpha = 1,
              inherit.aes = F, linejoin = "bevel", lineend = "round") +
    labs(x = "", y = "X (degrees)", color = "") +
    scale_color_manual(breaks=c(color_breaks),
                       values = c(color_vals),
                     drop = F)  + 
    scale_fill_manual(color_breaks,
                       values = color_vals,
                     drop = F)  + 
    scale_y_continuous(limits = c(-15, 15)) +
    jov_theme  +
    theme(axis.text.x=element_blank(), legend.position = "none")

#    coord_fixed(ratio = .05)  + 
#    guides(col = guide_legend(override.aes = list(shape = 15, size = 8))) 
  
    ycoord <- df_trials %>%
      full_join(occlusion_starts) %>%
    mutate(trial_ts = trial_ts - occl_start) %>%
    filter(participant == sbj, trial_number == trialn) %>%
    mutate(target_class = factor(target_class, levels = c("Object", "Visible", "Hidden", "Target"))) %>%
    mutate(seg_fill = factor(seg_fill, levels = c("Gaze", "Smooth pursuit", "Saccade"))) %>%
    ggplot() + 
#    geom_rect(data=rects, aes(xmin=xmin, ymin=ymin, xmax=xmax, ymax=ymax, 
#        fill=target_class, group=1), alpha = .4) +  
    geom_path(aes(trial_ts, target_y, color = target_class, group=target_class), 
              alpha = 1, size = 1) +
    geom_path(aes(trial_ts, gazeY_s, color = seg_fill, group=1), size = 1, alpha = 1,
              inherit.aes = F, linejoin = "bevel", lineend = "round") +
    labs(x = "", y = "Y (degrees)", color = "") +
    scale_color_manual(breaks=c(color_breaks),
                       values = c(color_vals),
                     drop = F)  + 
    scale_fill_manual(color_breaks,
                       values = color_vals,
                     drop = F)  + 
    jov_theme +
#    coord_fixed(ratio = .05)  + 
    guides(color = guide_legend(override.aes = list(alpha = .6))) +
      scale_y_continuous(limits = c(-15, 15)) + theme(axis.text.x=element_blank(), legend.position = "none")
    
    list(xcoord, ycoord)
    
}



trial_xy_times <- plot_segm_xy(8, 393)


pxy <- ggarrange(plotlist = trial_xy_times, ncol = 1, align = "hv") 



pxy
```


### 1c. phase-radius time series
```{r}

plot_segm_phaserad <- function(sbj, trialn) {

  
  phase <- df_trials %>%
    full_join(occlusion_starts) %>%
    mutate(trial_ts = trial_ts - occl_start) %>%
    filter(participant == sbj, trial_number == trialn) %>%
    mutate(target_class = factor(target_class, levels = c("Object", "Visible", "Hidden", "Target"))) %>%
    mutate(seg_fill = factor(seg_fill, levels = c("Gaze", "Smooth pursuit", "Saccade"))) %>%
    mutate(seg_id = data.table::rleid(seg_fill)) %>%
    ggplot() + 
#    geom_rect(data=rects, aes(xmin=xmin, ymin=ymin, xmax=xmax, ymax=ymax, 
#        fill=target_class, group=1), alpha = .4) +  
    geom_path(aes(trial_ts, unwrap_target_phase_R, color = target_class, group=target_class), 
              alpha = 1, size = 1) +
    geom_path(aes(trial_ts, unwrap_gaze_phase_R, color = seg_fill, group=1), size = 1, alpha = 1,
              inherit.aes = F, linejoin = "bevel", lineend = "round") +
    labs(x = "", y = "Phase (turns)", color = "") +
    scale_color_manual(breaks=c(color_breaks),
                       values = c(color_vals),
                     drop = F)  + 
    scale_fill_manual(color_breaks,
                       values = color_vals,
                     drop = F)  + 
    scale_y_continuous(labels = formatterphase, breaks = seq(-2, 2, by = .5)*2*pi) +
    jov_theme  +
    theme(axis.text.x=element_blank(), legend.position = "none")

#    coord_fixed(ratio = .05)  + 
#    guides(col = guide_legend(override.aes = list(shape = 15, size = 8))) 
  
    radius <- df_trials %>%
      full_join(occlusion_starts) %>%
    mutate(trial_ts = trial_ts - occl_start) %>%
    filter(participant == sbj, trial_number == trialn) %>%
    mutate(target_class = factor(target_class, levels = c("Object", "Visible", "Hidden", "Target"))) %>%
    mutate(seg_fill = factor(seg_fill, levels = c("Gaze", "Smooth pursuit", "Saccade"))) %>%
    ggplot() + 
#    geom_rect(data=rects, aes(xmin=xmin, ymin=ymin, xmax=xmax, ymax=ymax, 
#        fill=target_class, group=1), alpha = .4) +  
    geom_path(aes(trial_ts, target_radius, color = target_class, group=target_class), 
              alpha = 1, size = 1) +
    geom_path(aes(trial_ts, gaze_radius, color = seg_fill, group=1), size = 1, alpha = 1,
              inherit.aes = F, linejoin = "bevel", lineend = "round") +
    labs(x = "Time (s)", y = "Radius (degrees)", color = "") +
    scale_color_manual(breaks=c(color_breaks),
                       values = c(color_vals),
                     drop = F)  + 
    scale_fill_manual(color_breaks,
                       values = color_vals,
                     drop = F)  + 
    jov_theme +
#    coord_fixed(ratio = .05)  + 
    guides(color = guide_legend(override.aes = list(alpha = .6))) +
      scale_y_continuous(limits = c(10, 17), breaks = c(10, 13.5, 17)) + theme(legend.position = "none")
    
    list(phase, radius)
    
}



trial_times <- plot_segm_phaserad(8, 393)


p_phaserad <- ggarrange(plotlist = trial_times, ncol = 1, align = "hv") 



p_phaserad

```

```{r}

#pp <- ggarrange(plotlist = list(p, trial_circ), ncol = 2, widths = c(2, 2.2)) 

pp_left <- ggarrange(plotlist = c(trial_xy_times, trial_times), ncol = 1, align = "hv") 


pp <- ggarrange(plotlist = list(pp_left, trial_circ + theme(legend.direction = "vertical",
        legend.position = "bottom")), 
        ncol = 2, widths = c(2.8, 2.4)) 

```




```{r}
ggsave(filename="jov_figures/trial_illustr.pdf", plot=pp, width=19, height = 13, units = "cm") # TODO add xintercept (as below), make a bit smaller
```


### 2 time series of euclidean, phase and radius offset




```{r}
# linear interpolation for regular timestamps

ts <- df_trials %>%
  filter(trial_type == "occluded_trial") %>%
  mutate(gt_abs_dist = sqrt((gazeX_s - target_x)^2 + (gazeY_s - target_y)^2)) %>%
  group_by(participant, trial_number) %>%
  mutate(occl_start = ifelse(occl_ts == 0, trial_ts, NA_real_)) %>%
  mutate(occl_ts2 = trial_ts - max(occl_start, na.rm=T)) %>% 
  ungroup %>%
  select(participant, trial_number, occl_ts2, gt_abs_dist, phase_diff_unwrap, radius_diff)

# set common starting ts for all trials. then use reglin on each participant+trial. then remove NAs 
ts_interp <- ts %>%
  group_by(participant, trial_number) %>%
  group_modify(~reglin(.x$occl_ts2, .x$gt_abs_dist, xmin = min(ts$occl_ts2), deltat = 1/60, rule=1) %>% data.frame) %>%
  ungroup %>%
  filter(!is.na(y)) %>%
  rename(occl_ts2 = x, gt_abs_dist = y)



# calculate references: 1. if gaze is stuck at disappearance point, 2. middle of screen, 3. tangent of disappearance point
refdata <- df_trials %>%
  filter(trial_type == "occluded_trial", participant == 4, trial_number == 326, !is.na(occl_ts)) %>% # pick trial with max occlusion
  mutate(gaze_start_x = if_else(occl_ts == 0, target_x, NA_real_),
         gaze_start_y = if_else(occl_ts == 0, target_y, NA_real_),
         vel_start = if_else(occl_ts == 0, lead(target_y) - target_y, NA_real_),
         slope_start = if_else(occl_ts == 0, 
                               ((target_y - lag(target_y)) / (target_x - lag(target_x))) %>% lead, 
                               NA_real_)) %>%
  fill(slope_start) %>%
  fill(gaze_start_y) %>%
  fill(gaze_start_x) %>%
  fill(vel_start) %>%
  mutate(gaze_start_phase = if_else(occl_ts == 0, unwrap_target_phase_R, NA_real_),
         gaze_start_radius = if_else(occl_ts == 0, target_radius, NA_real_)) %>%
  fill(gaze_start_phase, gaze_start_radius) %>%
  mutate(ic = gaze_start_y - slope_start * gaze_start_x) %>%
  mutate(vel_coef = 1/(1 + exp(seq(-5, 0, length.out = n())))) %>% # velocity coefficient to create velocity decay (sigmoid shape 1/(1 + exp(x)) for x -5...0)
  mutate(#yd = (abs(lag(target_y) - target_y)*vel_coef) %>% lead,
         yd = abs(vel_start)*vel_coef,      
         tangent_y = (gaze_start_y + cumsum(yd)) %>% lag) %>% # y continues to grow; note velocity coefficient
  mutate(tangent_x = -(ic - tangent_y) / (slope_start))  # find x values of tangent


refdata %>%
  ggplot(aes(target_x, target_y)) + geom_path() +
  geom_path(aes(tangent_x, tangent_y))

refdata %>%
  gather(var, value, tangent_x, tangent_y) %>%
  ggplot(aes(trial_ts, value, color = var)) + geom_line()

 
reflines <- refdata %>%
   mutate(dis_magn = sqrt((gaze_start_x - target_x)^2 + (gaze_start_y - target_y)^2),
          cen_magn = sqrt((0 - target_x)^2 + (0 - target_y)^2),
          tan_magn = sqrt((tangent_x - target_x)^2 + (tangent_y - target_y)^2)) %>%
  mutate(dis_phase = gaze_start_phase - unwrap_target_phase_R,
         tan_phase = atan2(tangent_x, tangent_y) + 2*pi - unwrap_target_phase_R,
       #  dis_radius = gaze_start_radius - target_radius,
       #  cen_radius = 0 - target_radius,
         tan_radius = sqrt((tangent_x)^2 + (tangent_y)^2) - target_radius)

reflines_magn <- reflines %>%
  select(occl_ts, ends_with("_magn")) %>%
  gather(refline, value, -occl_ts) %>%
  mutate(refline = recode(refline, dis_magn = "Disappearance point", cen_magn = "Center",
                          tan_magn = "Tangent"))


# first take MEDIAN for each timestamp (instead of geometric mean, due to hassle with negative values)
# rolling mean 

diff1 <- ts_interp %>%
  group_by(participant, occl_ts2) %>%
  summarise(gt_abs_dist = median(gt_abs_dist)) %>%
  group_by(participant) %>%
  arrange(participant, occl_ts2) %>%
  mutate(GM = rollmean(gt_abs_dist, k=25, fill=NA, align="center")) %>% 
  ungroup %>%
  filter(!is.na(GM)) %>%
    ggplot(aes(occl_ts2, GM)) +  geom_line(aes(color = participant), size = 1, alpha = .8) +
  geom_vline(xintercept = 0, alpha = .3) +
  geom_line(data = reflines_magn, aes(occl_ts, value, linetype = refline %>% fct_rev)) +
  labs(x = "Time (s)", y = "Euclidean distance (degrees)", linetype = "Reference line", color = "Participant") +
  scale_color_d3() +
  scale_y_continuous(limits = c(0, 35)) +
  jov_theme

```

```{r}
ts_interp_phase <- ts %>%
  group_by(participant, trial_number) %>%
  group_modify(~reglin(.x$occl_ts2, .x$phase_diff_unwrap, xmin = min(ts$occl_ts2), deltat = 1/60, rule=1) %>% data.frame) %>%
  ungroup %>%
  filter(!is.na(y)) %>%
  rename(occl_ts2 = x, phase_diff_unwrap = y)


reflines_phase <- reflines  %>%
  select(occl_ts, dis_phase, tan_phase) %>%
  gather(refline, value, -occl_ts) %>%
  mutate(refline = recode(refline, dis_phase = "Disappearance point", 
                          tan_phase = "Tangent"))


diff2 <- ts_interp_phase %>%
  group_by(participant, occl_ts2) %>%
  summarise(phase_diff_unwrap = median(phase_diff_unwrap)) %>%
  group_by(participant) %>%
  arrange(participant, occl_ts2) %>%
  mutate(GM = rollmean(phase_diff_unwrap, k=25, fill=NA, align="center")) %>%
  ungroup %>%
  filter(!is.na(GM)) %>%
  ggplot(aes(occl_ts2, GM)) +  geom_line(aes(color = participant), size = 1, alpha = .8) +
  geom_vline(xintercept = 0, alpha = .3) +
  geom_line(data = reflines_phase, aes(occl_ts, value, linetype = refline %>% fct_rev)) +
  labs(x = "Time (s)", y = "Phase difference (turns)", linetype = "Reference line", color = "Participant") +
  scale_color_d3() + 
  scale_y_continuous(labels = formatterphase, breaks = seq(-.75, .25, by = .25)*2*pi, limits = c(-2.5, .5)) +
  jov_theme


```

```{r}

ts_interp_radius <- ts %>%
  group_by(participant, trial_number) %>%
  group_modify(~reglin(.x$occl_ts2, .x$radius_diff, xmin = min(ts$occl_ts2), deltat = 1/60, rule=1) %>% data.frame) %>%
  ungroup %>%
  filter(!is.na(y)) %>%
  rename(occl_ts2 = x, radius_diff = y)


reflines_radius <- reflines  %>%
  select(occl_ts, tan_radius) %>%
  gather(refline, value, -occl_ts) %>%
  mutate(refline = recode(refline, tan_radius = "Tangent"))


diff3 <- ts_interp_radius %>%
  group_by(participant, occl_ts2) %>%
  summarise(radius_diff = median(radius_diff)) %>%
  group_by(participant) %>%
  arrange(participant, occl_ts2) %>%
  mutate(GM = rollmean(radius_diff, k=25, fill=NA, align="center")) %>%
  ungroup %>%
  filter(!is.na(GM)) %>%
    ggplot(aes(occl_ts2, GM)) +  geom_line(aes(color = participant), size = 1, alpha = .8) +
  geom_vline(xintercept = 0, alpha = .3) +
  geom_line(data = reflines_radius, aes(occl_ts, value, linetype = refline %>% fct_rev)) +
  labs(x = "Time (s)", y = "Radius difference (degrees)", linetype = "Reference line", 
       color = "Participant") +
  scale_y_continuous(limits = c(-13.5, 13.5)) +
  scale_color_d3() +
  jov_theme

```

```{r}
diff_plots <- ggarrange(diff1 + xlab("") + theme(axis.text.x=element_blank()), 
                        diff2 + xlab("") + theme(axis.text.x=element_blank()), 
                        diff3, 
                        common.legend = T, ncol = 1, legend = "right", align = "hv")

```
```{r}
ggsave(filename="jov_figures/diff_panels.pdf", plot=diff_plots, width=18, height = 17, units = "cm")
```


# saccade latencies

```{r}
slat <- saccades %>%
  filter(timept == "launch", first_saccade) %>%
  ggplot(aes(x=occl_ts, y=..density..)) + 
#  geom_histogram(color = "black", fill = NA, boundary = 0, binwidth = .03) + 
  stat_bin(aes(y=..density..), geom="step", binwidth = .03, size = 1, boundary = 0) +
  labs(x = "Time (s)", y = "Density") + jov_theme

ggsave(filename="jov_figures/saccade_lat.pdf", plot=slat, width=10, height = 8, units = "cm")
```

# Phase pursuit gain


```{r}
occlusion_starts <- df_trials %>%
  group_by(participant, trial_number) %>%
  filter(occl_ts == 0) %>%
  select(participant, trial_number, trial_ts) %>%
  rename(occl_start = trial_ts)

pgain <- seg_data$pursuit %>% 
  full_join(occlusion_starts) %>%
  mutate(trial_ts = trial_ts - occl_start) %>%
  group_by(participant, trial_number, seg_index) %>%
  mutate(split_seg = n_distinct(target_class) > 1) %>% 
  ggplot(aes(trial_ts - seg_dur, phase_speed / (pi/2), # beginning times of pursuit segments
             color = split_seg,
             group = interaction(participant, trial_number))) +
  geom_point(alpha = .1, size = 1.5, show.legend = F) +
  scale_y_continuous(limits = c(0, 2)) +
  labs(x = "Time (s)", y = "Pursuit gain") +
  geom_vline(xintercept = 0, alpha = .3) +
  scale_color_manual(values = c("black", "darkred")) +
  jov_theme

ggsave(filename="jov_figures/pgain.pdf", plot=pgain, width=10, height = 8, units = "cm")

```

# phase angle change over time

```{r}
int_data %>% 
  arrange(participant, trial_number, target_class, cond_ts, seg)

```


```{r}

plot_phase_int <- function(cond) {
  
# namelabel <- function(x) {
#   paste0("participant ", x)
# }

p <-  int_data %>%
    mutate(target_class = str_to_title(target_class)) %>%
  filter(target_class == cond) %>%
  spread(seg, cumulative_phasedist) %>% 
  mutate(saccade = ifelse(is.na(saccade), 0, saccade)) %>%
  ggplot(aes(group = interaction(participant, trial_number))) +
  geom_ribbon(aes(cond_ts, ymin = pursuit, ymax = pursuit + saccade, fill = "Saccade"), alpha = .03)  +
  geom_ribbon(aes(cond_ts, ymin = 0, ymax = pursuit, fill = "Smooth pursuit"), alpha = .03) +
  geom_line(aes(cond_ts, total_cphasedist, group = interaction(participant, trial_number)), alpha = .1, inherit.aes = F) +
  #            aes(cond_ts, cumulative_phasedist), alpha = .8) +
  geom_line(aes(cond_ts, cond_ts * (pi/2)), linetype = "dashed", color = "white",
            size=1, inherit.aes = F) +
#  facet_wrap(~participant, labeller = labeller(participant = namelabel), ncol = 2)  +
  labs(title = str_to_title(cond),
       #subtitle = "Cumulative phase angle change by saccades/pursuits",
       y = "Cumulative phase (turns)",
       x = "Time (s)", color = "", fill = "") +
#  geom_smooth(aes(cond_ts, cumulative_phasedist, color = seg), inherit.aes = F,
#              method = "lm", se = F, linetype = "dashed") +
#  scale_fill_manual(values = c("Pursuit" = "#1F77B4FF", "Saccade" = "#FF7F0EFF")) +
    scale_fill_manual(breaks=c(color_breaks),
                       values = c(color_vals),
                     drop = F) + 
  scale_y_continuous(labels = formatterphase, breaks = seq(0, 2, by = .25)*2*pi, limits = c(0, 5)) +
  scale_x_continuous(limits = c(0,3)) +
  guides(fill = guide_legend(override.aes = list(alpha = 1))) +
  jov_theme

p
}


phaseplots <- lapply(c("Visible", "Hidden"), plot_phase_int)

phaseplots[[2]] <- phaseplots[[2]] + labs(y = "")  + theme(axis.text.y=element_blank())

phase_covered <- ggarrange(plotlist = phaseplots, common.legend = T, ncol = 2, legend = "bottom", align = "hv") 

phase_covered


```

```{r}

ggsave(filename="jov_figures/total_phase.pdf", plot=phase_covered, width=19, height = 9, units = "cm")

```


# saccade frequency & amplitude
```{r}

# reference line: if saccade amplitude is X, how many saccades per second are needed to cover the tracking (at a given pursuit gain)?
# X = (2*radius^2 − amp^2) / (2*radius^2)
# angle A = acos(X) radians

# circle moves at pi/2 radians/s. therefore, with angle A, speed/A saccades are needed per second (for purely saccadic tracking).


ref_freq <- function(amp, pg) { # pg = pursuit gain from 0 (pure saccadic) to 1 (pure pursuit)
  radius = 13.5
  obj_speed = pi/2
  sacc_speed = obj_speed - (pg*obj_speed)
  
  X <- (2*radius^2 - amp^2) / (2*radius^2)
  A <- acos(X)

  # circle moves at 1.57 radians/s. therefore, with angle A, speed/A saccades are needed per second.
  sacc_speed/A
}

```

```{r}
# get values for PG from observed amplitude & frequency data:

trial_saccades_cut %>%
  mutate(ampX = (2*13.5^2 - median_dist^2) / (2*13.5^2),
         ampA = acos(ampX)) %>%
  mutate(sacc_speed = freq*ampA, # formulas derived from above: gaze_speed = freq*ampA
         pg = ((pi/2) - sacc_speed)/(pi/2)) %>% #  pg = (obj_speed - sacc_speed)/(obj_speed)
  group_by(target_class) %>%
  summarise(median(pg, na.rm=T))

# use median PG for each condition to plot reference lines
amp_ref <- tibble(amp = seq(0.1, 15, .2), freq_pg0 = ref_freq(amp, 0), freq_pg.4 = ref_freq(amp, .46),
                  freq_pg.9 = ref_freq(amp, .9))
         
```

NOTE: PG in hidden is probably higher because of the first ~0.5 s included.

```{r}
freq_amp <- trial_saccades_cut %>%
  mutate(target_class = str_to_title(target_class)) %>%
  group_by(participant, target_class) %>%
  mutate(freq_part = median(freq),
         dist_part = median(median_dist)) %>%
  ggplot(aes(freq, median_dist, color = target_class %>% fct_rev)) + 
  geom_point(alpha = .6)  +
  geom_point(aes(freq_part, dist_part, fill = target_class %>% fct_rev), 
             color = "black", size = 2, shape = 21, show.legend = F) +
#  geom_line(aes(freq_part, dist_part, group = participant), inherit.aes = F, alpha = .3) +
  geom_line(aes(freq_pg0, amp, linetype = "0.00"), inherit.aes = F, data = amp_ref) +
  geom_line(aes(freq_pg.4, amp, linetype = "0.46"), inherit.aes = F, data = amp_ref) +
  geom_line(aes(freq_pg.9, amp, linetype = "0.90"), inherit.aes = F, data = amp_ref) +
#  annotate("text", x = 4, y = .1, label = "PG .90", size = 3.6) +
#  annotate("text", x = 6.5, y = 1.4, label = "PG .46", size = 3.6) +
#  annotate("text", x = 6.6, y = 2.6, label = "PG 0", size = 3.6) +
  guides(color = guide_legend(override.aes = list(alpha = 1, size = 3))) +
  scale_y_continuous(limits = c(0,20)) +
  scale_x_continuous(limits = c(0,7)) +
  labs(x = "Frequency (saccades/s)", y = "Median saccade amplitude (degrees)", color = "Object") +
  scale_linetype_manual(values = c("0.00" = "dotted", "0.46" = "dashed", "0.90" = "solid"),
                        name = "Pursuit gain") +
    scale_fill_manual(breaks=c(color_breaks),
                       values = c(color_vals),
                     drop = F) + 
    scale_color_manual(breaks=c(color_breaks),
                       values = c(color_vals),
                     drop = F) +
  jov_theme 
# 
# trial_saccades_cut %>%
#   group_by(participant, target_class) %>%
#   mutate(freq_part = median(freq),
#          dist_part = median(median_dist)) %>%
#   ggplot(aes(freq, median_dist, color = target_class %>% fct_rev)) + 
#   geom_point(alpha = .2)  +
#   geom_point(aes(freq_part, dist_part, fill = target_class %>% fct_rev), color = "black", size = 2, shape = 21, show.legend = F) +
#   geom_line(aes(freq_part, dist_part, group = participant), inherit.aes = F, alpha = .3) +
#   geom_line(aes(freq_pg.4, amp), inherit.aes = F, data = amp_ref) +
#   geom_line(aes(freq_pg.9, amp), inherit.aes = F, data = amp_ref) +
#   theme_bw() +
# #  scale_color_manual(values = color_vals) +
# #  scale_fill_manual(values = color_vals) +
#   guides(color = guide_legend(override.aes = list(alpha = 1, size = 3))) +
#   scale_y_continuous(limits = c(0,20)) +
#   scale_x_continuous(limits = c(0,7)) +
#   labs(x = "Frequency (saccades/s)", y = "Median saccade amplitude", color = "") +
#   scale_color_d3() +
#   scale_fill_d3() 


```

```{r}

ggsave(filename="jov_figures/freq_amp.pdf", plot=freq_amp, width=14, height = 10, units = "cm")

```


```{r}
with(trial_saccades, cor.test(median_dist, median_phasedist))

```

# phase difference: saccade launch/landing points

```{r}


ggplot() + 
    geom_histogram(data = d,aes(x = x),breaks = seq(-4,4,by=.5),
                                 color = "red",fill = "transparent") + 
    geom_step(data = d1,aes(x = x,y = y),stat = "identity")


saccade_ll <- saccades %>% 
  filter(!first_saccade) %>% 
  filter(signtype == "cue", !is.na(timept), trial_type == "occluded_trial", 
         target_class == "hidden") %>%
  mutate(timept = str_to_title(timept)) %>%
  ggplot(aes(x = phase_diff_unwrap, y = ..density.., color = timept %>% fct_rev)) + 
#  geom_histogram(binwidth=.05, position = "identity", alpha = .8)  + 
  geom_vline(aes(xintercept = 0), alpha = .7, color = "darkgrey") +
  stat_bin(aes(y=..density..), geom="step", binwidth = .05, size = 1, alpha = .8) +
  annotate(geom = "text", x = .25, y = -.015, label = "Lead", color = "darkgrey", alpha = 1) +
  annotate(geom = "text", x = -.21, y = -.015, label = "Lag", color = "darkgrey", alpha = 1) +  
  labs(color = "",
       x = "Phase difference (turns)", y = "Density") +
    scale_color_manual(values = c("Launch" = "#FF7F2EFF", "Landing" = "#D62728FF")) + 
  scale_x_continuous(labels = formatterphase, breaks = seq(-2, 2, by = .25)*2*pi, limits = c(-2,2)) +
  jov_theme

```

```{r}
ggsave(filename="jov_figures/saccade_ll.pdf", plot=saccade_ll, width=14, height = 8, units = "cm")

```


numbers: median phase differences for first saccades & other saccades



# time series: avg phase difference per participant at launch/landing

```{r}
saccades %>%
  ggplot(aes(trial_ts, phase_diff_unwrap, color = timept)) + geom_point(alpha = .6) +
  facet_wrap(~participant)

```

# Phase and radius SD over time

```{r}

phasesd <- sddata %>% 
  gather(var, value, ends_with("std")) %>%
  filter(var == "phase_std") %>%
  filter(n_valid >= 5) %>%
  ggplot(aes(ts, value, color = factor(participant))) +  # no phase formatter needed here
  geom_line() +
#  facet_wrap(~var, scales = "free_y", strip.position = "left", ncol= 1) + 
  labs(x = "", color = "Participant", y = "Phase difference SD (turns)") +
  jov_theme  +
  scale_color_d3() +
  theme(axis.text.x=element_blank()) 

radiussd <- sddata %>% 
  gather(var, value, ends_with("std")) %>%
  filter(var == "radius_std") %>%
  filter(n_valid >= 5) %>%
  ggplot(aes(ts, value, color = factor(participant))) +  # no phase formatter needed here
  geom_line() +
#  facet_wrap(~var, scales = "free_y", strip.position = "left", ncol= 1) + 
  labs(x = "Time (s)", color = "Participant", y = "Radius difference SD (degrees)") +
  scale_color_d3() +
  jov_theme 

p <- ggarrange(phasesd, radiussd, ncol = 1, align = "hv", common.legend = T, legend = "right") 

p
```
```{r}
ggsave(filename="jov_figures/phase_radius_sd.pdf", plot=p, width=19, height = 14, units = "cm")

```

