---
title: "1st paper figures"
output: html_notebook
---

```{r setup}
library(ggpubr)
library(pastecs)
library(zoo)
library(ggsci)
library(RColorBrewer)
library(viridisLite)
library(tidyverse)

df_trials <- readRDS('df_trials.RDS')
seg_data <- readRDS('saccade_pursuit_full.rds')
int_data <- readRDS('saccade_pursuit_int.rds')
trial_saccades <- readRDS('trial_saccades.rds')

```


Use the Helvetica font.  
Use approximately 10-point type for axis numbers, and 12-point type for axis labels.  
The type should be about the size of type in the body text, when the figure is created at the desired size.  
Do not use boldface.  
Do not use too wide a range of font sizes (less than a range of 8 points).  
Do not use 3D shapes for 2D data.  
Do not use bar charts when line graphs will do.  
Do not place a title at the top of the figure; this should go in the figure caption.  
Do not draw lines or shadows around the outside of the figure.  
Use color to distinguish data series, or for other useful didactic purposes, but not for decoration.  
Capitalize the first letter of the first word in the axis labels. 
If the axis labels include units, place them in parentheses.  
Avoid repeating axis labels in multi-panel figures.  

```{r plot_specs}
# colors 
# separate colors for: 
# 1. participants: (d3 palette (10/20) OR) viridis default palette


# 2. gaze: saccade/pursuit: a pair from d3-10

# 3. object: hidden/visible/target: a triplet from d3-10/20

scales::show_col(pal_d3("category10")(10))
scales::show_col(pal_d3("category20")(20))

show_col(viridis_pal()(30))
show_col(viridis_pal(direction = -1)(10))

scales::show_col(pal_npg("nrc")(9))
scales::show_col(pal_lancet("lanonc")(10))

display.brewer.all(colorblindFriendly = TRUE)

# # change these

color_vals <- c( # actual colors used in the plot
                                "saccade" = "red",
                                "pursuit" = "darkgreen",
                                "target" = "blue",
                                "visible" = "deepskyblue",
                                "hidden" = "darksalmon",
                                # placeholder values for legend titles
                                " " = "white")
#
color_breaks <- c("saccade", "pursuit", " ", "target","visible","hidden")

# other specs

jov_theme = theme_bw(base_size = 12, #base_family = "Helvetica"
                     ) + 
  theme(panel.grid.major = element_line(size = 0.5, color = "grey"),
axis.line = element_line(size = 0.7, color = "black"), legend.position = c(0.85,
0.7), text = element_text(size = 14))

```

```{r}

#PHASE FORMATTER (radians -> turns)

formatterphase <- function(x){ 
    x / (2*pi)
}

# add this to plot
 scale_y_continuous(labels = formatterphase, breaks = seq(-.75, .25, by = .25)*2*pi)
  
```


## 1 Illustrative time series

### 1a. screen x-y, saccades + pursuits

```{r}
plot_trial <- function(sbj, trialn) {

  #isochronic lines at the ends of segments
isochronic_ts <- df_trials %>%
    filter(participant == sbj, trial_number == trialn) %>%
    group_by(data.table::rleid(seg_fill)) %>%
    filter(ts == max(ts)) %>% 
    ungroup %>% pull(trial_ts)


# can't see number 3 and 9 -> adjust. make sure this is visible!!
isochronic_ts[3] <- isochronic_ts[3] - 0.04198366 #0.461927 # 1.298052 # 1.717995201


isochronic_lines <- df_trials %>%
   filter(participant == sbj, trial_number == trialn) %>%
    mutate(across(c(target_x, target_y, gazeX_s, gazeY_s), .names = "{col}_segm")) %>%
    filter(round(trial_ts,6) %in% round(isochronic_ts[1:8],6)) %>%
    select(ends_with("segm")) %>%
    rename(gaze_x_segm = gazeX_s_segm, gaze_y_segm = gazeY_s_segm) %>%
    rownames_to_column() %>%
    gather(var, value, -rowname) %>%
    separate(var, into = c("var", "coord"), extra = "drop") %>%
    spread(coord, value) %>%
    arrange(rowname, desc(var)) 



  
curve_df <- df_trials %>%
  filter(participant == sbj, trial_number == trialn) %>%
  slice(1:45)

df_trials %>%
    filter(participant == sbj, trial_number == trialn) %>%
    ggplot() + 
    geom_path(aes(target_x, target_y, color = target_class, group=1), 
              alpha = .4, show.legend = F, size =1) +
    geom_line(data = isochronic_lines, aes(x, y, group = rowname, 
                                           color = "isochronic lines"), 
              linetype = "dashed", inherit.aes = F) +
    geom_path(aes(gazeX_s, gazeY_s, color = seg_fill, group=1), 
              alpha = 1, inherit.aes = F, size = 1) +
    geom_point(aes(0, 0, color = " "), alpha = 0) +
#    geom_curve(aes(x = target_x1 + 2, y = target_y1, 
#                   xend = target_x2 + 2, yend = target_y2), data = curve_df, 
#                   curvature = -0.15) +
    geom_path(aes(target_x, target_y - 2), data = curve_df) +
    geom_segment(aes(x=curve_df$target_x[nrow(curve_df)-1], xend=curve_df$target_x[nrow(curve_df)], 
                     y=curve_df$target_y[nrow(curve_df)-1] - 2, yend=curve_df$target_y[nrow(curve_df)] - 2), 
                           arrow = arrow(length = unit(0.5, "cm"))) +
    labs(colour = "", x = "X (degrees)", y = "Y (degrees)") +
    coord_fixed() +
    theme_bw()  +
    scale_y_continuous(limits = c(-16, 16)) +
    scale_x_continuous(limits = c(-16, 16)) +
    scale_color_manual(breaks=c(color_breaks, "isochronic lines"),
                       values = c(color_vals, "isochronic lines" = "black"),
                     drop = F)

}

# a trial with occlusion, saccades & pursuits; less than one full circle (for clarity); phase/radius offset (for illustration)

circ_trials <- df_trials %>%
  filter(trial_type == "occluded_trial") %>%
  group_by(participant, trial_number) %>%
  filter(between(max(ts) - min(ts), 2.5, 3.5)) %>%
  distinct(participant, trial_number)

# t <- mapply(plot_trial, circ_trials$participant, circ_trials$trial_number, SIMPLIFY = F)
# 
# pdf("circle_plots_temp.pdf", width = 12, height = 12)
# invisible(lapply(t, print))
# dev.off()


#plot_trial(8, 412)
#plot_trial(8, 425)
#plot_trial(8, 430)



```

```{r}
plot_trial(8, 393)

```


### 1b. phase-radius, saccades + pursuits
```{r}
plot_segm_phaserad <- function(sbj, trialn) {
  

  # rects <- df_trials %>%
  #   filter(participant == sbj, trial_number == trialn) %>%
  #   arrange(trial_ts) %>%
  #   group_by(trial_number, target_class) %>%
  #   summarise(xmin = min(trial_ts),
  #             xmax = max(trial_ts)) %>%
  #   ungroup %>%
  #   mutate(ymin = -20, ymax = 20)
  
  
    trialdur <- df_trials %>%
    filter(participant == sbj, trial_number == trialn) %>%
      summarise(trial_duration = max(trial_ts)) %>%
      pull(trial_duration)
  
  phase <- df_trials %>%
    filter(participant == sbj, trial_number == trialn) %>%
    ggplot() + 
#    geom_rect(data=rects, aes(xmin=xmin, ymin=ymin, xmax=xmax, ymax=ymax, 
#        fill=target_class, group=1), alpha = .4) +  
    geom_path(aes(trial_ts, phase_diff_unwrap, group=1), alpha = .8) +
    geom_path(aes(trial_ts, unwrap_gaze_phase_R, color = seg_fill, group=1), alpha = .8) +
    geom_path(aes(trial_ts, unwrap_target_phase_R, color = target_class, group=1), alpha = .8) +
    theme_bw() +
    scale_color_manual(breaks=c(color_breaks, "isochronic lines"),
                       values = c(color_vals, "isochronic lines" = "orange"),
                     drop = F)  + 
    scale_fill_manual(color_breaks,
                       values = color_vals,
                     drop = F)  + 
  scale_y_continuous(labels = formatterphase, breaks = seq(-.75, .25, by = .25)*2*pi)

#    coord_fixed(ratio = .05)  + 
#    guides(col = guide_legend(override.aes = list(shape = 15, size = 8))) 
  
    radius <- df_trials %>%
    filter(participant == sbj, trial_number == trialn) %>%
    ggplot() + 
#    geom_rect(data=rects, aes(xmin=xmin, ymin=ymin, xmax=xmax, ymax=ymax, 
#        fill=target_class, group=1), alpha = .4) +  
    geom_path(aes(trial_ts, gaze_radius, color = seg_fill, group=1), alpha = .8) +
    geom_path(aes(trial_ts, target_radius, color = target_class, group=1), alpha = .8) +
    theme_bw() +
    scale_y_continuous(limits = c(0, 27)) +
    scale_color_manual(breaks=c(color_breaks, "isochronic lines"),
                       values = c(color_vals, "isochronic lines" = "orange"),
                     drop = F)  + 
    scale_fill_manual(color_breaks,
                       values = color_vals,
                     drop = F) 
#    coord_fixed(ratio = .05)  + 
#    guides(col = guide_legend(override.aes = list(shape = 15, size = 8))) 
    
    radius
    phase
}


phase
radius

plot_segm_phaserad(8, 393)
```

### 2 time series of euclidean, phase and radius offset




```{r}
# linear interpolation for regular timestamps

ts <- df_trials %>%
  filter(trial_type == "occluded_trial") %>%
  mutate(gt_abs_dist = sqrt((gazeX_s - target_x)^2 + (gazeY_s - target_y)^2)) %>%
  group_by(participant, trial_number) %>%
  mutate(occl_start = ifelse(occl_ts == 0, trial_ts, NA_real_)) %>%
  mutate(occl_ts2 = trial_ts - max(occl_start, na.rm=T)) %>% 
  ungroup %>%
  select(participant, trial_number, occl_ts2, gt_abs_dist, phase_diff_unwrap, radius_diff)

# set common starting ts for all trials. then use reglin on each participant+trial. then remove NAs 
ts_interp <- ts %>%
  group_by(participant, trial_number) %>%
  group_modify(~reglin(.x$occl_ts2, .x$gt_abs_dist, xmin = min(ts$occl_ts2), deltat = 1/60, rule=1) %>% data.frame) %>%
  ungroup %>%
  filter(!is.na(y)) %>%
  rename(occl_ts2 = x, gt_abs_dist = y)



# calculate references: 1. if gaze is stuck at disappearance point, 2. middle of screen, 3. tangent of disappearance point
refdata <- df_trials %>%
  filter(trial_type == "occluded_trial", participant == 4, trial_number == 326, !is.na(occl_ts)) %>% # pick trial with max occlusion
  mutate(gaze_start_x = if_else(occl_ts == 0, target_x, NA_real_),
         gaze_start_y = if_else(occl_ts == 0, target_y, NA_real_),
         vel_start = if_else(occl_ts == 0, lead(target_y) - target_y, NA_real_),
         slope_start = if_else(occl_ts == 0, 
                               ((target_y - lag(target_y)) / (target_x - lag(target_x))) %>% lead, 
                               NA_real_)) %>%
  fill(slope_start) %>%
  fill(gaze_start_y) %>%
  fill(gaze_start_x) %>%
  fill(vel_start) %>%
  mutate(gaze_start_phase = if_else(occl_ts == 0, unwrap_target_phase_R, NA_real_),
         gaze_start_radius = if_else(occl_ts == 0, target_radius, NA_real_)) %>%
  fill(gaze_start_phase, gaze_start_radius) %>%
  mutate(ic = gaze_start_y - slope_start * gaze_start_x) %>%
  mutate(vel_coef = 1/(1 + exp(seq(-5, 0, length.out = n())))) %>% # velocity coefficient to create velocity decay (sigmoid shape 1/(1 + exp(x)) for x -5...0)
  mutate(#yd = (abs(lag(target_y) - target_y)*vel_coef) %>% lead,
         yd = abs(vel_start)*vel_coef,      
         tangent_y = (gaze_start_y + cumsum(yd)) %>% lag) %>% # y continues to grow; note velocity coefficient
  mutate(tangent_x = -(ic - tangent_y) / (slope_start))  # find x values of tangent


refdata %>%
  ggplot(aes(target_x, target_y)) + geom_path() +
  geom_path(aes(tangent_x, tangent_y))

refdata %>%
  gather(var, value, tangent_x, tangent_y) %>%
  ggplot(aes(trial_ts, value, color = var)) + geom_line()

 
reflines <- refdata %>%
   mutate(dis_magn = sqrt((gaze_start_x - target_x)^2 + (gaze_start_y - target_y)^2),
          cen_magn = sqrt((0 - target_x)^2 + (0 - target_y)^2),
          tan_magn = sqrt((tangent_x - target_x)^2 + (tangent_y - target_y)^2)) %>%
  mutate(dis_phase = gaze_start_phase - unwrap_target_phase_R,
         tan_phase = atan2(tangent_x, tangent_y) + 2*pi - unwrap_target_phase_R,
       #  dis_radius = gaze_start_radius - target_radius,
       #  cen_radius = 0 - target_radius,
         tan_radius = sqrt((tangent_x)^2 + (tangent_y)^2) - target_radius)

reflines_magn <- reflines %>%
  select(occl_ts, ends_with("_magn")) %>%
  gather(refline, value, -occl_ts) %>%
  mutate(refline = recode(refline, dis_magn = "Disappearance point", cen_magn = "Center",
                          tan_magn = "Tangent"))


# first take MEDIAN for each timestamp (instead of geometric mean, due to hassle with negative values)
# rolling mean 

ts_interp %>%
  group_by(participant, occl_ts2) %>%
  summarise(gt_abs_dist = median(gt_abs_dist)) %>%
  group_by(participant) %>%
  arrange(participant, occl_ts2) %>%
  mutate(GM = rollmean(gt_abs_dist, k=25, fill=NA, align="center")) %>% 
  ungroup %>%
  filter(!is.na(GM)) %>%
    ggplot(aes(occl_ts2, GM)) +  geom_line(aes(color = participant), size = 1, alpha = .8) +
  theme_bw() +
  geom_vline(xintercept = 0, alpha = .3) +
  geom_line(data = reflines_magn, aes(occl_ts, value, linetype = refline %>% fct_rev)) +
  labs(x = "Time (s)", y = "Angular difference", linetype = "Reference line", color = "Participant") +
  scale_color_d3()

```

```{r}
ts_interp_phase <- ts %>%
  group_by(participant, trial_number) %>%
  group_modify(~reglin(.x$occl_ts2, .x$phase_diff_unwrap, xmin = min(ts$occl_ts2), deltat = 1/60, rule=1) %>% data.frame) %>%
  ungroup %>%
  filter(!is.na(y)) %>%
  rename(occl_ts2 = x, phase_diff_unwrap = y)


reflines_phase <- reflines  %>%
  select(occl_ts, dis_phase, tan_phase) %>%
  gather(refline, value, -occl_ts) %>%
  mutate(refline = recode(refline, dis_phase = "Disappearance point", 
                          tan_phase = "Tangent"))


ts_interp_phase %>%
  group_by(participant, occl_ts2) %>%
  summarise(phase_diff_unwrap = median(phase_diff_unwrap)) %>%
  group_by(participant) %>%
  arrange(participant, occl_ts2) %>%
  mutate(GM = rollmean(phase_diff_unwrap, k=25, fill=NA, align="center")) %>%
  ungroup %>%
  filter(!is.na(GM)) %>%
  ggplot(aes(occl_ts2, GM)) +  geom_line(aes(color = participant), size = 1, alpha = .8) +
  theme_bw() +
  geom_vline(xintercept = 0, alpha = .3) +
  geom_line(data = reflines_phase, aes(occl_ts, value, linetype = refline %>% fct_rev)) +
  labs(x = "Time (s)", y = "Phase difference (turns)", linetype = "Reference line", color = "Participant") +
  scale_color_d3() + 
  scale_y_continuous(labels = formatterphase, breaks = seq(-.75, .25, by = .25)*2*pi)


```

```{r}

ts_interp_radius <- ts %>%
  group_by(participant, trial_number) %>%
  group_modify(~reglin(.x$occl_ts2, .x$radius_diff, xmin = min(ts$occl_ts2), deltat = 1/60, rule=1) %>% data.frame) %>%
  ungroup %>%
  filter(!is.na(y)) %>%
  rename(occl_ts2 = x, radius_diff = y)


reflines_radius <- reflines  %>%
  select(occl_ts, tan_radius) %>%
  gather(refline, value, -occl_ts) %>%
  mutate(refline = recode(refline, tan_radius = "Tangent"))


ts_interp_radius %>%
  group_by(participant, occl_ts2) %>%
  summarise(radius_diff = median(radius_diff)) %>%
  group_by(participant) %>%
  arrange(participant, occl_ts2) %>%
  mutate(GM = rollmean(radius_diff, k=25, fill=NA, align="center")) %>%
  ungroup %>%
  filter(!is.na(GM)) %>%
    ggplot(aes(occl_ts2, GM)) +  geom_line(aes(color = participant), size = 1, alpha = .8) +
  theme_bw() +
  geom_vline(xintercept = 0, alpha = .3) +
  geom_line(data = reflines_radius, aes(occl_ts, value, linetype = refline %>% fct_rev)) +
  labs(x = "Time (s)", y = "Radius difference", linetype = "Reference line", color = "Participant") +
  scale_y_continuous(limits = c(-13.5, 13.5)) +
  scale_color_d3()

```

# saccade latencies

```{r}
saccades %>%
  filter(timept == "launch", first_saccade) %>%
  ggplot(aes(x=occl_ts, y=..density..)) + geom_histogram(color = "black", fill = NA,
                                                         boundary = 0, binwidth = .03) + 
  theme_bw() +
  labs(x = "Time hidden (s)", y = "Density")

```

# Phase pursuit gain

```{r}
occlusion_starts <- df_trials %>%
  group_by(participant, trial_number) %>%
  filter(occl_ts == 0) %>%
  select(participant, trial_number, trial_ts) %>%
  rename(occl_start = trial_ts)

seg_data$pursuit %>% 
  full_join(occlusion_starts) %>%
  mutate(trial_ts = trial_ts - occl_start) %>%
  group_by(participant, trial_number, seg_index) %>%
  mutate(split_seg = n_distinct(target_class) > 1) %>% 
  ggplot(aes(trial_ts - seg_dur, phase_speed / (pi/2), # beginning times of pursuit segments
             color = split_seg,
             group = interaction(participant, trial_number))) +
  geom_point(alpha = .1, size = 1.5) +
  scale_y_continuous(limits = c(0, 2)) +
  labs(x = "Time (s)", y = "Phase gain") +
  theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed") +
  scale_color_manual()



```

