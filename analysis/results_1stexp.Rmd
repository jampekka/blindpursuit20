---
title: "1st exp results"
output: 
  html_notebook:
    code_folding: hide
    toc: yes
---

```{r setup, include=F}
library(ggpubr)
library(tidyverse)
library(lme4)
library(lmerTest)
library(broom.mixed)
```

```{r include=F}
df_trials <- readRDS('df_trials.RDS')
saccades <- readRDS('saccades.RDS')

```

```{r colors}
# not so colorblind-friendly...

color_vals <- c( # actual colors used in the plot
                                "saccade" = "red", 
                                "pursuit" = "darkgreen", 
                                "target" = "blue", 
                                "visible" = "deepskyblue",
                                "hidden" = "darksalmon",
                                # placeholder values for legend titles
                                " " = "white")

color_breaks <- c("saccade", "pursuit", " ", "target","visible","hidden")

```



```{r wrangling, message=F}
  
df_dur <- df_trials %>%
  filter(signtype == "cue", trial_type == "occluded_trial", 
         target_class %in% c("visible", "hidden")) %>%
  spread(target_class, ts) %>%
  group_by(participant, trial_number) %>%
  summarise(visible = max(visible, na.rm=T) - min(visible, na.rm=T),
            hidden = max(hidden, na.rm=T) - min(hidden, na.rm=T)) %>%
  ungroup %>%
  pivot_longer(cols = c("visible", "hidden"),
               names_to = "target_class",
               values_to = "duration") %>%
  filter(!is.infinite(duration))

saccadetimes_full <- saccades %>%
  filter(signtype == "cue", trial_type == "occluded_trial") %>%
  group_by(participant, seg_index, target_class) %>%
  filter(n_distinct(timept) == 2) %>% 
  arrange(participant, seg_index, desc(timept)) %>%
  group_by(participant, seg_index) %>%
  mutate(dist = sqrt((gazeX_s - lag(gazeX_s))^2 + (gazeY_s - lag(gazeY_s))^2) %>% lead,
         phasedist = (unwrap_gaze_phase_R - lag(unwrap_gaze_phase_R)) %>% lead,
         radiusdist = (gaze_radius - lag(gaze_radius)) %>% lead,
         saccade_dur = (ts - lag(ts)) %>% lead) %>%
  filter(timept == "launch")  %>%
  ungroup %>%
  mutate(cond_ts = if_else(target_class == "hidden", occl_ts, trial_ts)) %>%
  select(participant, seg_index, cond_ts, dist, phasedist, radiusdist, saccade_dur, trial_number, target_class) %>%
  arrange(participant, target_class, trial_number, cond_ts) %>%
  group_by(participant, target_class, trial_number) %>%
  mutate(cumulative_saccades = cumsum(!is.na(seg_index)),
         cumulative_phasedist = cumsum(phasedist),
         cumulative_target_phasedist = (cond_ts + saccade_dur) * (pi/2),
         cum_rel_phasedist = cumulative_phasedist / cumulative_target_phasedist) %>% 
  ungroup

full_ts_saccades <- df_trials %>%
  filter(signtype == "cue", trial_type == "occluded_trial") %>%
  mutate(cond_ts = if_else(target_class == "hidden", occl_ts, trial_ts)) %>%
  select(participant, trial_number, target_class, cond_ts) %>%
  full_join(saccadetimes_full, by = c("participant", "trial_number", "target_class", "cond_ts"))
  

trial_saccades <- saccadetimes_full %>%
  group_by(participant, trial_number, target_class) %>%
  summarise(saccades = n_distinct(seg_index),
            median_dist = median(dist),
            median_phasedist = median(phasedist),
            total_phasedist = sum(phasedist)) %>%
  ungroup %>%
  left_join(df_dur, by = c("participant", "trial_number", "target_class")) %>%
  mutate(freq = saccades/duration,
         target_phasedist = duration * (pi/2))


```

## Saccade frequency

### Visible vs. occluded target: trial-level frequencies

Trial-level frequency (saccades/second) is calculated as the sum of saccades divided by the duration of (visible/hidden) time segment.  

Some outliers: e.g. participant 8, trial 450 during occlusion (frequency 14.3; 1 saccade during a period of 0.07 s).  

```{r fig.width=10, fig.height=10}
trial_saccades %>% 
  gather(var, value, saccades, duration, freq) %>%
  mutate(var = factor(var, levels = c("freq", "saccades", "duration"),
                      labels = c("Frequency (saccades/s)", "Saccade count", "Duration of visible/hidden cue (s)"))) %>%
  ggplot(aes(participant, value, fill = target_class %>% fct_rev)) + geom_boxplot() +
  facet_wrap(~var, scales = "free", ncol = 1, strip.position = "left") +
  theme_bw() +
  scale_fill_manual(values = color_vals) +
  labs(title = "Saccade frequency: participant-wise distributions", y = "", fill = "")  +
    theme(strip.placement = "outside", 
          strip.background = element_blank())


```


### Saccade frequency over time

```{r fig.width=10, fig.height=7}

trial_saccades %>%
  ggplot(aes(duration, freq, color = target_class)) +
  geom_point(alpha = .3, size = 1) +
  facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " "))  +
  theme_bw() +
  labs(title = "Trial-level saccade frequencies over time", y = "Frequency (saccades/s)",
       x = "Duration of visible/hidden cue (s)", color = "") +
  scale_color_manual(values = color_vals) +
  guides(color = guide_legend(override.aes = list(alpha = 1, size = 3)))

```


### Within trials


```{r fig.width=10, fig.height=7}

# saccadetimes_full %>% 
#   arrange(participant, target_class, trial_number, cond_ts) %>%
#   group_by(participant, target_class, trial_number) %>%
#   mutate(cumulative_saccades = cumsum(!is.na(seg_index))) %>%
#   ungroup %>%
#   ggplot(aes(cond_ts, cumulative_saccades,
#              group = interaction(participant, target_class, trial_number), color = target_class)) +
#   geom_line(alpha = .2) +
#   facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
#   labs(title = "Saccade count over time",
#        y = "Cumulative saccade count", x = "Duration of visible/hidden cue (s)", color = "") +
#   geom_smooth(aes(cond_ts, cumulative_saccades, color = target_class), inherit.aes = F,
#               method = "lm", se = F, linetype = "dashed") +
#   theme_bw()  +
#   scale_color_manual(values = color_vals)



csaccades <- saccadetimes_full %>%
  arrange(participant, target_class, trial_number, cond_ts) %>%
  group_by(participant, target_class, trial_number) %>%
  mutate(cumulative_saccades = cumsum(!is.na(seg_index))) %>%
  ungroup

zero_saccades <- csaccades %>%
  distinct(participant, target_class, trial_number) %>%
  anti_join(csaccades %>% filter(cond_ts == 0), by = c("participant", "target_class", "trial_number")) %>%
  mutate(cond_ts = 0,
         cumulative_saccades = 0)

csaccades %>%
  full_join(zero_saccades, by = c("participant", "cond_ts", "trial_number", "target_class", "cumulative_saccades")) %>%
  arrange(participant, target_class, cond_ts) %>%
  # group_by(participant) %>%
  # mutate(slope = round(lm(cumulative_saccades ~ cond_ts)$coefficients[2], 2)) %>%
  # ungroup %>%
  # mutate(participant2 = participant) %>%
  # mutate(participant = paste0(participant, " (slope ", slope, ")") %>% factor) %>%
  # mutate(participant = fct_reorder(participant, as.numeric(participant2))) %>%
  ggplot(aes(cond_ts, cumulative_saccades,
             group = interaction(participant, target_class, trial_number), color = target_class)) +
  geom_line(alpha = .25) +
  facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
  labs(title = "Saccade count over time",
       y = "Cumulative saccade count", x = "Duration of visible/hidden cue (s)", color = "") +
  geom_smooth(aes(cond_ts, cumulative_saccades, color = target_class), inherit.aes = F,
              method = "lm", se = F, linetype = "dashed") +
  theme_bw()  +
  scale_color_manual(values = color_vals)


```

```{r fig.width=10, fig.height=7}
csaccades %>%
  full_join(zero_saccades, by = c("participant", "cond_ts", "trial_number", "target_class", "cumulative_saccades")) %>%
  arrange(participant, target_class, cond_ts) %>%
  ggplot(aes(log(cond_ts+1), log(cumulative_saccades+1),
             group = interaction(participant, target_class, trial_number), color = target_class)) +
  geom_path(alpha = .2) +
  facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
  labs(title = "Saccade count over time (log-log)",
       y = "LOG Cumulative saccade count", x = "LOG Duration of visible/hidden cue (s)", 
       color = "") +
  geom_smooth(aes(log(cond_ts+1), log(cumulative_saccades+1), color = target_class), inherit.aes = F,
              method = "lm", se = F, linetype = "dashed") +
  theme_bw()  +
  scale_color_manual(values = color_vals)


```


In the plot below, cumulative frequency has been calculated from the cumulative sum of *saccades per trial* (saccade count scaled by n of trials at each timepoint).  

```{r fig.width=10.5, fig.height=7, message=F}
# occl_ts_saccades %>%
#   mutate(occl_bin = cut_width(occl_ts, 1/50), boundary = 0) %>%
#   group_by(participant, occl_bin) %>%
#   summarise(saccades = sum(!is.na(seg_index)),
#             trials = n_distinct(trial_number),
#             occl_ts_bound = max(occl_ts)) %>%
#   arrange(participant, occl_ts_bound) %>%
#   mutate(saccades_per_trial = saccades / trials, # scale count by n of trials
#          cumulative_saccades = cumsum(saccades_per_trial),
#          cs_freq = cumulative_saccades / occl_ts_bound) %>% 
#   ggplot(aes(occl_ts_bound, cs_freq, color = participant)) + #geom_path(size=1, alpha = .7) +
#   geom_point(aes(size=trials)) +
#   facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
#   labs(title = "Saccade frequency over time",
#        y = "Cumulative frequency (saccades/s)", x = "Occlusion duration (s)") +
#   theme_bw() + scale_size("Number of trials", range = c(0.01, 3), breaks = c(10,35,60)) + guides(color = F) +
#   theme(legend.position = "bottom")

# this df has "all timestamps" (also the ones without saccades)
full_ts_saccades %>%
  mutate(ts_bin = cut_width(cond_ts, 1/60), boundary = 0) %>%
  group_by(participant, target_class, ts_bin) %>%
  summarise(saccades = sum(!is.na(seg_index)),
            trials = n_distinct(trial_number),
            ts_bound = max(cond_ts)) %>%
  arrange(participant, target_class, ts_bound) %>%
  mutate(saccades_per_trial = saccades / trials, # scale count by n of trials
         cumulative_saccades = cumsum(saccades_per_trial),
         cs_freq = cumulative_saccades / ts_bound) %>% 
  ggplot(aes(ts_bound, cs_freq, size = trials, color = target_class)) + #geom_path(size=1, alpha = .7) +
  geom_point(alpha = .3) +
  facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
  labs(title = "Saccade frequency over time",
       y = "Cumulative frequency (saccades/s)", x = "Duration of visible/hidden cue (s)", color = "") +
  theme_bw() + scale_size("Number of trials", range = c(0.01, 3), breaks = c(10,35,60)) + 
  theme(legend.position = "bottom") +
  scale_color_manual(values = color_vals) +
  guides(color = guide_legend(override.aes = list(alpha = 1, size = 3)))


```


## Saccade amplitude

```{r fig.width=10, fig.height=7}

saccadetimes_full %>%
  ggplot(aes(participant, dist, fill = target_class)) + geom_boxplot() +
  theme_bw() +
  scale_fill_manual(values = color_vals) +
  scale_y_continuous(limits = c(0, 20)) +
  labs(title = "Saccade amplitude: participant-wise distributions", y = "Amplitude (degrees)", fill = "")  +
    theme(strip.placement = "outside", 
          strip.background = element_blank())



```


```{r fig.width=10, fig.height=7}
saccadetimes_full %>% 
  ggplot(aes(cond_ts, dist, 
             group = interaction(participant, trial_number), color = target_class)) + 
  geom_point(alpha = .2, size = 1) +
  facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
  labs(title = "Saccade amplitude over time", 
       y = "Amplitude (degrees)", x = "Duration of visible/hidden cue (s)", color = "") +
  theme_bw()  +
  scale_color_manual(values = color_vals) +
  guides(color = guide_legend(override.aes = list(alpha = 1, size = 3)))

```

### Scatter plot: frequency vs. amplitude

Trial-level saccade frequency vs. median saccade amplitude, all participants pooled. Points with black border (connected by thin line for each participant) are participant medians.  

```{r fig.width=10, fig.height=7}

trial_saccades %>%
  group_by(participant, target_class) %>%
  mutate(freq_part = median(freq),
         dist_part = median(median_dist)) %>%
  ggplot(aes(freq, median_dist, color = target_class %>% fct_rev)) + 
  geom_point(alpha = .2)  +
  geom_point(aes(freq_part, dist_part, fill = target_class %>% fct_rev), color = "black", size = 2, shape = 21, show.legend = F) +
  geom_line(aes(freq_part, dist_part, group = participant), inherit.aes = F, alpha = .2) +
  theme_bw() +
  scale_color_manual(values = color_vals) +
  scale_fill_manual(values = color_vals) +
  guides(color = guide_legend(override.aes = list(alpha = 1, size = 3))) +
  scale_y_continuous(limits = c(0,20)) +
  scale_x_continuous(limits = c(0,7)) +
  labs(x = "Frequency (saccades/s)", y = "Median saccade amplitude", color = "")

```

## Phase angle covered by saccades

```{r fig.width=10, fig.height=7}

saccadetimes_full %>% 
  ggplot(aes(participant, phasedist, fill = target_class)) + geom_boxplot() +
  theme_bw() +
  scale_fill_manual(values = color_vals) +
  labs(title = "Phase angle covered by saccades: participant-wise distributions", 
       subtitle = '"Absolute" phase angle change during a single saccade' ,
       y = "Phase angle change (radians)", fill = "")  +
    theme(strip.placement = "outside", 
          strip.background = element_blank())

```

### Trial-level: total phase angle covered by saccades

Outliers: short trial duration, 1-2 saccades

```{r fig.width=10, fig.height=7}

trial_saccades %>%
  mutate(rel_phasedist = total_phasedist / target_phasedist) %>% 
  ggplot(aes(participant, rel_phasedist, fill = target_class %>% fct_rev)) + geom_boxplot() +
  theme_bw() +
  scale_fill_manual(values = color_vals) +
  scale_y_continuous(labels = scales::percent) + 
  labs(title = "Phase angle covered by saccades: participant-wise distributions", 
       subtitle = "Proportion of saccadic phase angle changes out of total phase angle of object",
       y = "Percentage", fill = "")  +
    theme(strip.placement = "outside", 
          strip.background = element_blank())  


```
Negative phase changes: only about 5.8 % overall, but big individual differences

```{r fig.width=10, fig.height=7, message=F}

saccadetimes_full %>%
  summarise(negatives = mean(phasedist < 0)) 


saccadetimes_full %>%
  group_by(participant, target_class) %>%
  summarise(negatives = mean(phasedist < 0)) %>%
  ggplot(aes(participant, negatives, fill = target_class)) + geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::percent) +
  theme_bw() +
  scale_fill_manual(values = color_vals) +
  labs(fill = "")
# 
# saccadetimes_full %>%
#   filter(phasedist < 0) %>% droplevels() %>% complete(participant, target_class) %>%
#   ggplot(aes(participant, phasedist, fill = target_class)) + geom_boxplot() +
#   theme_bw() +
#   scale_fill_manual(values = color_vals, drop = F) +
#   labs(title = "Magnitudes of negative phase angle changes", 
#        y = "Phase angle change (radians)", fill = "")  +
#     theme(strip.placement = "outside", 
#           strip.background = element_blank())

```

Example of negative changes: p10 trial 463

```{r fig.width=10}
sbj = 10
trialn = 463

isochronic_lines <- df_trials %>%
    filter(participant == sbj, trial_number == trialn) %>%
    mutate(across(c(target_x, target_y, gazeX_s, gazeY_s), .names = "{col}_segm")) %>%
    slice(seq(1, n(), 100)) %>%
    select(ends_with("segm")) %>%
    rename(gaze_x_segm = gazeX_s_segm, gaze_y_segm = gazeY_s_segm) %>%
    rownames_to_column() %>%
    gather(var, value, -rowname) %>%
    separate(var, into = c("var", "coord"), extra = "drop") %>%
    spread(coord, value) %>%
    arrange(rowname, desc(var)) 
  
    title <- paste0("Participant ", sbj, ", trial ", trialn)
  
df_trials %>%
    filter(participant == sbj, trial_number == trialn) %>%
    ggplot() + 
    geom_path(aes(target_x, target_y, color = target_class, group=1), 
              alpha = .4, show.legend = F, size =1) +
    geom_line(data = isochronic_lines, aes(x, y, group = rowname, color = "isochronic lines"), 
              linetype = "dashed", inherit.aes = F) +
    geom_path(aes(gazeX_s, gazeY_s, color = seg_fill, group=1), 
              alpha = 1, inherit.aes = F, size = 1) +
    geom_point(aes(0, 0, color = " "), alpha = 0) +
    labs(colour = "", title = title) +
    coord_fixed() +
    theme_bw()  +
    scale_y_continuous(limits = c(-16, 16)) +
    scale_x_continuous(limits = c(-25, 25)) +
    scale_color_manual(breaks=c(color_breaks, "isochronic lines"),
                       values = c(color_vals, "isochronic lines" = "black"),
                     drop = F)

```



### Within trials


```{r fig.width=10, fig.height=7}

saccadetimes_full %>%
  ggplot(aes(cond_ts, phasedist,
             group = interaction(participant, target_class, trial_number), 
             color = target_class)) +
  geom_point(alpha = .2, size = 1) +
  facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
  labs(title = "Phase angle change over time",
       subtitle = '"Absolute" phase angle change during a single saccade',
       y = "Phase angle change (radians)", 
       x = "Duration of visible/hidden cue (s)", color = "") +
  scale_y_continuous(limits = c(-1,2)) +
#  geom_smooth(aes(cond_ts, cumulative_phasedist, color = target_class), inherit.aes = F,
#              method = "lm", se = F, linetype = "dashed") +
  theme_bw()  +
  scale_color_manual(values = color_vals) +
  guides(color = guide_legend(override.aes = list(alpha = 1, size = 3))) 


# plotdata %>% 
#   ggplot(aes(cond_ts, cum_rel_phasedist,
#              group = interaction(participant, target_class, trial_number), 
#              color = target_class)) +
#   geom_point(alpha = .2, size = 1) +
#   geom_path(alpha = .3) +
#   scale_y_continuous(limits = c(-1.2, 5)) +
#   # geom_point(data = plotdata %>% filter(phasedist < 0), 
#   #            aes(cond_ts, cum_rel_phasedist), alpha = .8) +
#   facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
#   labs(title = "Phase angle change over time",
#        subtitle = "Proportion of saccadic phase angle changes out of target phase angle",
#        y = "Relative phase angle change (cumulative)", 
#        x = "Duration of visible/hidden cue (s)", color = "") +
# #  geom_smooth(aes(cond_ts, cumulative_phasedist, color = target_class), inherit.aes = F,
# #              method = "lm", se = F, linetype = "dashed") +
#   theme_bw()  +
#   scale_color_manual(values = color_vals)

```

```{r fig.width=10, fig.height=7}

# plotdata %>%
#   ggplot(aes(cond_ts, cumulative_phasedist,
#              group = interaction(participant, target_class, trial_number), 
#              color = target_class)) +
# #  geom_point(alpha = .2, size = 1) +
#   geom_path(alpha = .25) +
#   # geom_point(data = plotdata %>% filter(phasedist < 0), 
#   #            aes(cond_ts, cumulative_phasedist), alpha = .8) +
#   facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
#   labs(title = "Phase angle change over time",
#        subtitle = "Cumulative phase angle change by saccades",
#        y = "Cumulative phase angle change (radians)", 
#        x = "Duration of visible/hidden cue (s)", color = "") +
#   geom_smooth(aes(cond_ts, cumulative_phasedist, color = target_class), inherit.aes = F,
#               method = "lm", se = F, linetype = "dashed") +
#   theme_bw()  +
#   scale_color_manual(values = color_vals) +
#   guides(color = guide_legend(override.aes = list(alpha = 1))) 

```

```{r fig.width=10, fig.height=7}

# "zero phases" included
zero_phases_sacc <- saccadetimes_full %>%
  distinct(participant, target_class, trial_number) %>%
  anti_join(saccadetimes_full %>% filter(cond_ts == 0), by = c("participant", "target_class", "trial_number")) %>%
  mutate(cond_ts = 0,
         cumulative_phasedist = 0)

plot_saccade_cp <- saccadetimes_full %>%
  full_join(zero_phases_sacc, by = c("participant", "cond_ts", "trial_number", "target_class", "cumulative_phasedist")) %>%
  arrange(participant, target_class, cond_ts) 


plot_saccade_cp %>%
  ggplot(aes(cond_ts, cumulative_phasedist,
             group = interaction(participant, target_class, trial_number), 
             color = target_class)) +
#  geom_point(alpha = .2, size = 1) +
  geom_path(alpha = .25) +
  # geom_point(data = plotdata %>% filter(phasedist < 0), 
  #            aes(cond_ts, cumulative_phasedist), alpha = .8) +
  geom_line(aes(cond_ts, cond_ts * (pi/2), color = "object phase angle"), linetype = "dashed", 
            alpha = .5, size=1, inherit.aes = F) +
  facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
  labs(title = "Phase angle change over time",
       subtitle = "Cumulative phase angle change by saccades",
       y = "Cumulative phase angle change (radians)", 
       x = "Duration of visible/hidden cue (s)", color = "") +
  geom_smooth(aes(cond_ts, cumulative_phasedist, color = target_class), inherit.aes = F,
              method = "lm", se = F, linetype = "dashed") +
  theme_bw()  +
  scale_color_manual(values = c(color_vals, "object phase angle" = "black")) # +
#  guides(color = guide_legend(override.aes = list(alpha = 1))) 



```

Saccade phase angles in log-log space
```{r fig.width=10, fig.height=7}

plot_saccade_cp %>%
  ggplot(aes(log1p(cond_ts), log1p(cumulative_phasedist),
             group = interaction(participant, target_class, trial_number), 
             color = target_class)) +
#  geom_point(alpha = .2, size = 1) +
  geom_path(alpha = .25) +
  # geom_point(data = plotdata %>% filter(phasedist < 0), 
  #            aes(cond_ts, cumulative_phasedist), alpha = .8) +
  geom_line(aes(log1p(cond_ts), log1p(cond_ts * (pi/2)), color = "object phase angle"), linetype = "dashed", 
            alpha = .5, size=1, inherit.aes = F) +
  facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
  scale_y_continuous(limits = c(0, log1p(5))) +
  labs(title = "Phase angle change over time (log-log)",
       subtitle = "Cumulative phase angle change by saccades",
       y = "LOG Cumulative phase angle change (radians)", 
       x = "LOG Duration of visible/hidden cue (s)", color = "") +
  geom_smooth(aes(log1p(cond_ts), log1p(cumulative_phasedist), color = target_class), inherit.aes = F,
              method = "lm", se = F, linetype = "dashed") +
  theme_bw()  +
  scale_color_manual(values = c(color_vals, "object phase angle" = "black")) # +
#  guides(color = guide_legend(override.aes = list(alpha = 1))) 

```
```{r}
# 
# fit_ts <- lmer(cumulative_phasedist ~ cond_ts * target_class + (1|participant), data = plot_saccade_cp)
# 
# 
# broom.mixed::augment(fit_ts) %>% 
#   ggplot(aes(cond_ts, cumulative_phasedist, color = target_class)) + 
#   geom_point(alpha = .15, size = 1) +
#   geom_line(aes(cond_ts, .fitted), alpha = 1) +
#   facet_wrap(~participant) +
#   theme_bw() +
#   theme(legend.position = "none")
# 
# 
# fit_ts2 <- lmer(cumulative_phasedist ~ cond_ts * target_class + (1|participant/trial_number), data = plot_saccade_cp)
# 
# fit_ts3 <- lmer(logcp ~ logts * target_class + (1|participant/trial_number), 
#                 data = plot_saccade_cp %>% 
#                   mutate(logcp = log1p(cumulative_phasedist),
#                          logts = log1p(cond_ts)))
# 
# summary(fit_ts)
# summary(fit_ts2)
# summary(fit_ts3)
# 
# glance(fit_ts)
# glance(fit_ts2)
# glance(fit_ts3)
# 
# broom.mixed::augment(fit_ts2) %>% 
#   ggplot(aes(cond_ts, cumulative_phasedist, color = target_class)) + 
#   geom_point(alpha = .15, size = 1) +
#   geom_line(aes(cond_ts, .fitted), alpha = 1) +
#   facet_wrap(~participant) +
#   theme_bw() +
#   theme(legend.position = "none")
# 
# broom.mixed::augment(fit_ts3) %>% 
#   ggplot(aes(exp(logts) - 1, exp(logcp) - 1, color = target_class)) + 
#   geom_point(alpha = .15, size = 1) +
#   geom_line(aes(exp(logts) - 1, exp(.fitted)-1), alpha = 1) +
#   facet_wrap(~participant) +
#   theme_bw() +
#   theme(legend.position = "none")

```


## Saccade launch/landing points during occlusion

```{r fig.width=10, fig.height=5}

saccades %>% 
  filter(!first_saccade) %>% 
  filter(signtype == "cue", !is.na(timept), trial_type == "occluded_trial", 
         target_class == "hidden") %>%
  ggplot(aes(phase_diff_unwrap, fill = timept)) + 
  geom_histogram(binwidth=.2, position = "identity", alpha = .4) +
  scale_x_continuous(limits = c(-2,2)) +
  geom_vline(aes(xintercept = 0), alpha = .5) +
  facet_wrap(~participant, scales = "free_y", ncol=5, 
             labeller = purrr::partial(label_both, sep = " ")) +
  labs(title = "Phase difference between saccade launch/landing points and object",
       subtitle = "Participant-wise distributions, occluded trials (1st saccade removed)", 
       fill = "",
       x = "Phase difference", y = "") +
  theme_bw() 


```




## Pursuits


```{r message=F}
#Phase change from start to end of pursuit segment vs. "phase travelled"  

#NOTE: Principle is different; cond_ts corresponds to *end time* of segment and phasedist to the phase change during that segment. Make the change to saccades too?


pursuit_timeseries <- df_trials %>%
  filter(trial_type == "occluded_trial", target_class %in% c("visible", "hidden")) %>%
  select(participant, trial_number, ts, target_class, seg_fill, unwrap_gaze_phase_R, unwrap_target_phase_R) %>%
  group_by(participant) %>%
  arrange(participant, ts) %>%
  mutate(seg_index = data.table::rleid(seg_fill)) %>%
  filter(seg_fill == "pursuit") %>%
  group_by(participant, trial_number, target_class) %>%
  mutate(cond_ts = ts - min(ts)) %>%
  select(-seg_fill, -ts) %>%
  ungroup

#cond_ts = pursuit begin point
pursuittimes_full <- pursuit_timeseries %>%
  group_by(participant, trial_number, target_class, seg_index) %>%
  arrange(participant, trial_number, target_class, seg_index, cond_ts) %>%
  summarise(pursuit_dur = max(cond_ts) - min(cond_ts),
            cond_ts = max(cond_ts),
            phasedist = last(unwrap_gaze_phase_R) - first(unwrap_gaze_phase_R),
            phase_speed = phasedist/pursuit_dur) %>%
  mutate(cumulative_phasedist = cumsum(phasedist),
         target_phasedist = (cond_ts) * (pi/2),
         cumulative_dur = cumsum(pursuit_dur)) %>%
  ungroup

```

## Phase angle covered by pursuits


```{r fig.width=10, fig.height=7}

pursuittimes_full %>% 
  ggplot(aes(participant, phasedist, fill = target_class)) + geom_boxplot() +
  theme_bw() +
  scale_fill_manual(values = color_vals) +
  labs(title = "Phase angle covered by pursuits: participant-wise distributions", 
       subtitle = '"Absolute" phase angle change during a single pursuit segment' ,
       y = "Phase angle change (radians)", fill = "")  +
  scale_y_continuous(limits = c(-0.5, 3)) +
    theme(strip.placement = "outside", 
          strip.background = element_blank())

```

### Trial-level: total phase angle covered by pursuits


```{r fig.width=10, fig.height=7, message=F}

pursuittimes_full %>%
  group_by(participant, trial_number, target_class) %>%
  summarise(total_phasedist = sum(phasedist)) %>%
  ungroup %>%
  left_join(df_dur) %>%
  mutate(target_phasedist = duration * (pi/2)) %>%
  mutate(rel_phasedist = total_phasedist / target_phasedist) %>% 
  ggplot(aes(participant, rel_phasedist, fill = target_class %>% fct_rev)) + geom_boxplot() +
  theme_bw() +
  scale_fill_manual(values = color_vals) +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1.5)) + 
  labs(title = "Phase angle covered by pursuits: participant-wise distributions", 
       subtitle = "Proportion of phase angle changes by pursuits out of total phase angle of object",
       y = "Percentage", fill = "")  +
    theme(strip.placement = "outside", 
          strip.background = element_blank())  

```

### Within trials

```{r fig.width=10, fig.height=7}

# "zero phases" included
zero_phases <- pursuittimes_full %>%
  distinct(participant, target_class, trial_number) %>%
  anti_join(pursuittimes_full %>% filter(cond_ts == 0), by = c("participant", "target_class", "trial_number")) %>%
  mutate(cond_ts = 0,
         cumulative_phasedist = 0)

plot_pursuit_cp <- pursuittimes_full %>%
  full_join(zero_phases, by = c("participant", "cond_ts", "trial_number", "target_class", "cumulative_phasedist")) %>%
  arrange(participant, target_class, cond_ts) 

plot_pursuit_cp %>%
  ggplot(aes(cond_ts, cumulative_phasedist,
             group = interaction(participant, target_class, trial_number),
             color = target_class)) +
#  geom_point(alpha = .2, size = 1) +
  geom_path(alpha = .2) +
  # geom_point(data = plotdata %>% filter(phasedist < 0),
  #            aes(cond_ts, cumulative_phasedist), alpha = .8) +
  geom_line(aes(cond_ts, cond_ts * (pi/2), color = "object phase angle"), linetype = "dashed", 
            alpha = .5, size=1, inherit.aes = F) +
  facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
  labs(title = "Phase angle change over time",
       subtitle = "Cumulative phase angle change by pursuits",
       y = "Cumulative phase angle change (radians)",
       x = "Duration of visible/hidden cue (s)", color = "") +
  geom_smooth(aes(cond_ts, cumulative_phasedist, color = target_class), inherit.aes = F,
              method = "lm", se = F, linetype = "dashed") +
  theme_bw() +
  scale_color_manual(values = c(color_vals, "object phase angle" = "black")) +
  scale_y_continuous(limits = c(0, 5)) +
  guides(color = guide_legend(override.aes = list(alpha = 1)))

# # NOTE some -3 values are missing
plot_pursuit_cp %>%
  ggplot(aes(log1p(cond_ts), log1p(cumulative_phasedist),
             group = interaction(participant, target_class, trial_number),
             color = target_class)) +
#  geom_point(alpha = .2, size = 1) +
  geom_path(alpha = .2) +
  # geom_point(data = plotdata %>% filter(phasedist < 0),
  #            aes(cond_ts, cumulative_phasedist), alpha = .8) +
  geom_line(aes(log1p(cond_ts), log1p(cond_ts * (pi/2)), color = "object phase angle"), linetype = "dashed",
            alpha = .5, size=1, inherit.aes = F) +
  facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
  labs(title = "Phase angle change over time (log-log)",
       subtitle = "Cumulative phase angle change by pursuits",
       y = "LOG Cumulative phase angle change (radians)",
       x = "LOG Duration of visible/hidden cue (s)", color = "") +
  geom_smooth(aes(log1p(cond_ts), log1p(cumulative_phasedist), 
                  color = target_class), inherit.aes = F,
              method = "lm", se = F, linetype = "dashed") +
  theme_bw() +
  scale_color_manual(values = c(color_vals, "object phase angle" = "black")) +
  scale_y_continuous(limits = c(0, log1p(5))) +
  guides(color = guide_legend(override.aes = list(alpha = 1)))

```


```{r fig.width=10, fig.height=7}
# pursuittimes_full %>%
#   ggplot(aes(cond_ts, cumulative_phasedist,
#              group = interaction(participant, target_class, trial_number),
#              color = target_class)) +
# #  geom_point(alpha = .2, size = 1) +
#   geom_path(alpha = .2) +
#   # geom_point(data = plotdata %>% filter(phasedist < 0),
#   #            aes(cond_ts, cumulative_phasedist), alpha = .8) +
#   geom_line(aes(cond_ts, cond_ts * (pi/2), color = "object phase angle"), linetype = "dashed", 
#             alpha = .5, size=1, inherit.aes = F) +
#   facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
#   labs(title = "Phase angle change over time",
#        subtitle = "Cumulative phase angle change by pursuits",
#        y = "Cumulative phase angle change (radians)",
#        x = "Duration of visible/hidden cue (s)", color = "") +
#   geom_smooth(aes(cond_ts, cumulative_phasedist, color = target_class), inherit.aes = F,
#               method = "lm", se = F, linetype = "dashed") +
#   theme_bw() +
#   scale_color_manual(values = c(color_vals, "object phase angle" = "black")) +
#   scale_y_continuous(limits = c(0, 5)) +
#   guides(color = guide_legend(override.aes = list(alpha = 1)))


```



```{r fig.width=10, fig.height=7, message = F}

# NOTE: cond_ts

pursuitjoin <- plot_pursuit_cp %>%
  select(participant:target_class, cond_ts, phasedist, cumulative_phasedist) %>%
  mutate(seg = "pursuit")

# plot_saccade_cp %>%
#   select(participant, trial_number, cond_ts, target_class, phasedist, cumulative_phasedist) %>%
#   mutate(seg = "saccade") %>%
#   rbind(pursuitjoin) %>%
#   ggplot(aes(cond_ts, cumulative_phasedist,
#              group = interaction(participant, seg, trial_number),
#              fill = seg)) +
# #  geom_point(alpha = .2, size = 1) +
#   geom_area(alpha = .05, position = "stack") +
#   # geom_point(data = plotdata %>% filter(phasedist < 0),
#   #            aes(cond_ts, cumulative_phasedist), alpha = .8) +
#   geom_line(aes(cond_ts, cond_ts * (pi/2), color = "object phase angle"), linetype = "dashed", 
#             alpha = .5, size=1, inherit.aes = F) +
#   facet_wrap(target_class~participant, labeller = purrr::partial(label_both, sep = " ")) +
#   # labs(title = "Phase angle change over time",
#   #      subtitle = "Cumulative phase angle change by pursuits",
#   #      y = "Cumulative phase angle change (radians)",
#   #      x = "Duration of visible/hidden cue (s)", color = "") +
# #  geom_smooth(aes(cond_ts, cumulative_phasedist, color = seg), inherit.aes = F,
# #              method = "lm", se = F, linetype = "dashed") +
#   theme_bw() +
# #  scale_color_manual(values = c(color_vals, "object phase angle" = "black")) +
#   scale_y_continuous(limits = c(0, 5)) +
#   guides(color = guide_legend(override.aes = list(alpha = 1)))


stackdata <- plot_saccade_cp %>%
  select(participant, trial_number, cond_ts, target_class, phasedist, cumulative_phasedist) %>%
  mutate(seg = "saccade") %>%
  rbind(pursuitjoin) %>%
  group_by(participant, target_class, trial_number) %>%
  complete(cond_ts, seg) %>% # add cumulative counts to cover whole trial
  arrange(participant, trial_number, target_class, seg, cond_ts) %>%
  group_by(participant, trial_number, target_class, seg) %>%
  mutate(cumulative_phasedist = if_else(is.na(cumulative_phasedist), lag(cumulative_phasedist), cumulative_phasedist)) %>%
  group_by(participant, target_class, trial_number, cond_ts) %>%
  mutate(total_cphasedist = sum(cumulative_phasedist)) %>%
  ungroup 


namelabel <- function(x) {
  paste0("participant ", x)
}


plot_phase <- function(cond) {
  p <- stackdata %>%
  filter(target_class == cond) %>%
  mutate(seg = fct_rev(seg)) %>%
  ggplot(aes(cond_ts, cumulative_phasedist,
             group = interaction(participant, seg, trial_number),
             fill = seg)) +
#  geom_point(alpha = .2, size = 1) +
  geom_area(alpha = .05, position = "stack") +
  geom_line(aes(cond_ts, total_cphasedist, group = interaction(participant, trial_number)), alpha = .2, inherit.aes = F) +
  # geom_point(data = plotdata %>% filter(phasedist < 0),
  #            aes(cond_ts, cumulative_phasedist), alpha = .8) +
  geom_line(aes(cond_ts, cond_ts * (pi/2), color = "object phase angle"), linetype = "dashed", 
            alpha = .5, size=1, inherit.aes = F) +
  facet_wrap(~participant, labeller = labeller(participant = namelabel), ncol = 2)  +
  labs(title = str_to_title(cond),
       #subtitle = "Cumulative phase angle change by saccades/pursuits",
       y = "Cumulative phase angle change (radians)",
       x = "Duration of cue (s)", color = "", fill = "") +
#  geom_smooth(aes(cond_ts, cumulative_phasedist, color = seg), inherit.aes = F,
#              method = "lm", se = F, linetype = "dashed") +
  theme_bw() +
  scale_color_manual(values = c(color_vals, "object phase angle" = "black")) +
  scale_fill_manual(values = color_vals) +
  scale_y_continuous(limits = c(0, 5)) +
  scale_x_continuous(limits = c(0,3)) +
  guides(fill = guide_legend(override.aes = list(alpha = 1)))
  
  p
}

phaseplots <- lapply(c("visible", "hidden"), plot_phase)

p <- ggarrange(plotlist = phaseplots, common.legend = T, ncol = 2, legend = "bottom") %>% 
  annotate_figure(top = "Phase angle change over time by saccades/pursuits")

p

```


```{r fig.width=10, fig.height=7}
plot_phaselog <- function(cond) {
  p <- stackdata %>%
  filter(target_class == cond) %>%
  mutate(seg = fct_rev(seg)) %>%
  ggplot(aes(log1p(cond_ts), log1p(cumulative_phasedist),
             group = interaction(participant, seg, trial_number),
             fill = seg)) +
#  geom_point(alpha = .2, size = 1) +
  geom_area(alpha = .05, position = "stack") +
  geom_line(aes(log1p(cond_ts), log1p(total_cphasedist), group = interaction(participant, trial_number)), alpha = .2, inherit.aes = F) +
  # geom_point(data = plotdata %>% filter(phasedist < 0),
  #            aes(cond_ts, cumulative_phasedist), alpha = .8) +
  geom_line(aes(log1p(cond_ts), 
                log1p(cond_ts * (pi/2)), color = "object phase angle"), linetype = "dashed", 
            alpha = .5, size=1, inherit.aes = F) +
  facet_wrap(~participant, labeller = labeller(participant = namelabel), ncol = 2)  +
  labs(title = str_to_title(cond),
       #subtitle = "Cumulative phase angle change by saccades/pursuits",
       y = "LOG Cumulative phase angle change (radians)",
       x = "LOG Duration of cue (s)", color = "", fill = "") +
#  geom_smooth(aes(cond_ts, cumulative_phasedist, color = seg), inherit.aes = F,
#              method = "lm", se = F, linetype = "dashed") +
  theme_bw() +
  scale_color_manual(values = c(color_vals, "object phase angle" = "black")) +
  scale_fill_manual(values = color_vals) +
  scale_y_continuous(limits = c(0, log1p(5))) +
  scale_x_continuous(limits = c(0, log1p(3))) +
  guides(fill = guide_legend(override.aes = list(alpha = 1)))
  
  p
}

phaseplotslog <- lapply(c("visible", "hidden"), plot_phaselog)

pp <- ggarrange(plotlist = phaseplotslog, common.legend = T, ncol = 2, legend = "bottom") %>% 
  annotate_figure(top = "Phase angle change over time by saccades/pursuits (log-log)")

pp

```


```{r fig.width=10, fig.height=7}
# stackdata %>%
#   group_by(participant, trial_number, target_class) %>%
#   mutate(vis_end = if_else(target_class == "visible", max(cond_ts), NA_real_)) %>%
#   group_by(participant, trial_number) %>%
#   fill(vis_end) %>%
#   mutate(ts_cont = if_else(target_class == "visible", cond_ts, vis_end + cond_ts)) %>%
#   group_by(participant, trial_number, target_class, seg) %>%
#   mutate(cp_end = if_else(target_class == "visible", max(cumulative_phasedist), NA_real_)) %>%
#   group_by(participant, trial_number, seg) %>%
#   fill(cp_end) %>%
#   mutate(cp_cont = if_else(target_class == "visible", cumulative_phasedist, cp_end + cumulative_phasedist)) %>%
#   mutate(seg = fct_rev(seg)) %>%
#   ggplot(aes(ts_cont, cp_cont,
#              group = interaction(participant, seg, trial_number),
#              fill = seg)) +
# #  geom_point(alpha = .2, size = 1) +
#   geom_area(alpha = .05, position = "stack") +
# #  geom_line(aes(ts_cont, total_cphasedist, group = interaction(participant, trial_number)), alpha = .2, inherit.aes = F) +
#   # geom_point(data = plotdata %>% filter(phasedist < 0),
#   #            aes(cond_ts, cumulative_phasedist), alpha = .8) +
#   geom_line(aes(ts_cont, ts_cont * (pi/2), color = "object phase angle"), linetype = "dashed", 
#             alpha = .5, size=1, inherit.aes = F) +
#   geom_vline(aes(xintercept = vis_end)) +
#   facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
# 
#   theme_bw() +
#   scale_color_manual(values = c(color_vals, "object phase angle" = "black")) +
#   scale_fill_manual(values = color_vals) +
#   guides(fill = guide_legend(override.aes = list(alpha = 1)))



```




```{r}
# Is more phase covered overall during hidden trials?
# df_trials %>%
#   filter(trial_type == "occluded_trial", target_class %in% c("visible", "hidden")) %>%
#   group_by(participant, trial_number, target_class) %>%
#   mutate(trial_dur = max(ts) - min(ts),
#             phase_change = last(unwrap_gaze_phase_R) - first(unwrap_gaze_phase_R),
#             tphase_change = last(unwrap_target_phase_R) - first(unwrap_target_phase_R)) %>%
# #  mutate(tpcheck = trial_dur * (pi/2)) %>%
#   mutate(phase_rel = phase_change / tphase_change) %>%
#   ggplot(aes(participant, phase_rel, fill = target_class)) + geom_boxplot(alpha = .5) 

```



```{r}
# nice plot but tells nothing new

# pursuittimes_full %>%
#   ggplot(aes(cond_ts, cumulative_phasedist/target_phasedist,
#              group = interaction(participant, target_class, trial_number), 
#              color = target_class)) +
#   geom_point(alpha = .2, size = 1) +
#   facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
#   # labs(title = "Phase angle change over time",
#   #      subtitle = '"Absolute" phase angle change during a single saccade',
#   #      y = "Phase angle change (radians)", 
#   #      x = "Duration of visible/hidden cue (s)", color = "") +
#   scale_y_continuous(limits = c(-1,2)) +
# #  geom_smooth(aes(cond_ts, cumulative_phasedist, color = target_class), inherit.aes = F,
# #              method = "lm", se = F, linetype = "dashed") +
#   theme_bw()  +
#   scale_color_manual(values = color_vals) +
#   guides(color = guide_legend(override.aes = list(alpha = 1, size = 3))) 


```


```{r fig.height=7, fig.width=10}

pursuittimes_full %>%
  ggplot(aes(cond_ts, phase_speed,
             group = interaction(participant, target_class, trial_number), 
             color = target_class)) +
  geom_point(alpha = .4, size = 1) +
  facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
  labs(title = "Angular speed of pursuit segments",
      # subtitle = "",
       y = "Speed (radians/s)",
       x = "Duration of visible/hidden cue (s)", color = "") +
  scale_y_continuous(limits = c(-1,2)) +
#  geom_smooth(aes(cond_ts, cumulative_phasedist, color = target_class), inherit.aes = F,
#              method = "lm", se = F, linetype = "dashed") +
  theme_bw()  +
  scale_color_manual(values = color_vals) +
  guides(color = guide_legend(override.aes = list(alpha = 1, size = 3))) 

  
pursuittimes_full %>%
  ggplot(aes(cond_ts, phasedist,
             group = interaction(participant, target_class, trial_number),
             color = target_class)) +
  geom_point(alpha = .2, size = 1) +
  facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
  # labs(title = "Phase angle change over time",
  #      subtitle = '"Absolute" phase angle change during a single saccade',
  #      y = "Phase angle change (radians)",
  #      x = "Duration of visible/hidden cue (s)", color = "") +
  scale_y_continuous(limits = c(-1,2)) +
#  geom_smooth(aes(cond_ts, cumulative_phasedist, color = target_class), inherit.aes = F,
#              method = "lm", se = F, linetype = "dashed") +
  theme_bw()  +
  scale_color_manual(values = color_vals) +
  guides(color = guide_legend(override.aes = list(alpha = 1, size = 3)))
# 
# pursuittimes_full %>%
#   ggplot(aes(cond_ts, pursuit_dur,
#              group = interaction(participant, target_class, trial_number), 
#              color = target_class)) +
#   geom_point(alpha = .2, size = 1) +
#   facet_wrap(~participant, labeller = purrr::partial(label_both, sep = " ")) +
#   # labs(title = "Phase angle change over time",
#   #      subtitle = '"Absolute" phase angle change during a single saccade',
#   #      y = "Phase angle change (radians)", 
#   #      x = "Duration of visible/hidden cue (s)", color = "") +
#   scale_y_continuous(limits = c(-1,2)) +
# #  geom_smooth(aes(cond_ts, cumulative_phasedist, color = target_class), inherit.aes = F,
# #              method = "lm", se = F, linetype = "dashed") +
#   theme_bw()  +
#   scale_color_manual(values = color_vals) +
#   guides(color = guide_legend(override.aes = list(alpha = 1, size = 3))) 

  
```



